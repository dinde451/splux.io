var GLOBAL_SPEED=.006,VIEWPORT_RADIUS=30,MAX_ZOOM=430,BLOCKS_ON_SCREEN=1100,WAIT_FOR_DISCONNECTED_MS=1e3,USERNAME_SIZE=6,COMPATIBLE_CLIENT_VERSION=1,CLIENT_VERSION=28,JS_VERSION=80,IS_DEV_BUILD=!1;!function(){for(var e="x",t=document.getElementsByTagName("script"),n=0;n<t.length;n++){var a=t[n].src;0<a.indexOf("//splix.io/js/")&&(e=a.substring(a.indexOf("splix.io/js/")+12,a.length-3))}e=parseInt(e),isNaN(e)?IS_DEV_BUILD=!0:JS_VERSION=e}();var MAX_PIXEL_RATIO=function(){var e=document.createElement("canvas").getContext("2d");return(window.devicePixelRatio||1)/(e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1)}(),DeviceTypes={DESKTOP:0,IOS:1,ANDROID:2},deviceType=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream?DeviceTypes.IOS:-1<navigator.userAgent.toLowerCase().indexOf("android")?DeviceTypes.ANDROID:DeviceTypes.DESKTOP;testHashForMobile();var patreonQueryWasFound=checkPatreonQuery();function redirectQuery(){var e=location.href.indexOf("#"),t=location.href.indexOf("?");if((0<=t&&(-1==e||t<e)||isIframe())&&(!patreonQueryWasFound||isIframe())){var n=["gp","siteId","channelId","siteLocale","storageId"],a=parseQuery(location.href);for(var i in a)a.hasOwnProperty(i)&&-1==n.indexOf(i)&&delete a[i];isIframe()&&(a.gp="1",a.siteId=window.location.hostname,a.channelId="1",a.siteLocale="en_EN",a.storageId="72167631167");var o=[];for(var i in a)a.hasOwnProperty(i)&&o.push(window.encodeURIComponent(i)+"="+window.encodeURIComponent(a[i]));var s=(s=o.join("&"))&&"?"+s,r=location.href.split("?")[0]+s;r!=location.href&&(location.href=r)}}function isIframe(){try{return window.self!==window.top}catch(e){return!0}}redirectQuery();var mainCanvas,ctx,minimapCtx,wsOnOpenTime,minimapCanvas,myScoreElem,myKillsElem,myRealScoreElem,myRankElem,totalPlayersElem,leaderboardElem,leaderboardDivElem,miniMapPlayer,playUI,beginScreen,notificationElem,formElem,appLinksElem,nameInput,linesCanvas,linesCtx,tempCanvas,tempCtx,transitionCanvas,tCtx,tutorialCanvas,tutCtx,tutorialBlocks,tutorialPlayers,tutorialText,skinButtonCanvas,skinButtonCtx,skinButtonShadow,shareToUnlock,skinCanvas,skinCtx,skinScreen,skinScreenBlocks,shareTw,shareFb,titCanvas,titCtx,socialElem,honkStartTime,zoom,myColorId,lastStatValueElem,bestStatValueElem,joinButton,teamBox,teamBoxLoading,teamBoxLoaded,teamShareCopyBtn,gamemodeDropDownEl,teamPlayersList,teamNameH,teamNameInput,IS_SECURE=0<=location.protocol.indexOf("https"),SECURE_WS=IS_SECURE?"wss://":"ws://",SKIN_BLOCK_COUNT=13,SKIN_PATTERN_COUNT=28,ws=null,prevTimeStamp=null,blocks=[],players=[],camPos=[0,0],camPosSet=!1,camPosPrevFrame=[0,0],myNameAlphaTimer=0,myPos=null,myPlayer=null,changeDirAt=null,changeDirAtIsHorizontal=!1,myNextDir=0,lastChangedDirPos=null,lastClientsideMoves=[],trailPushesDuringRequest=[],isRequestingMyTrail=!1,skipTrailRequestResponse=!1,mapSize=2e3,closedBecauseOfDeath=!1,beginScreenVisible=!0,canvasQuality=1,currentDtCap=0,totalDeltaTimeFromCap=0,deltaTime=16.66,lerpedDeltaTime=16.66,missedFrames=[],gainedFrames=[],myRank=0,myRankSent=!1,totalPlayers=0,leaderboardHidden="true"==localStorage.leaderboardHidden,lastNameValue="",lastTeamNameValue="",lastNameChangeCheck=0,scoreStatTarget=25,scoreStat=25,realScoreStatTarget=25,realScoreStat=25,showCouldntConnectAfterTransition=!1,playingAndReady=!1,canRunAds=!1,transitionTimer=0,transitionPrevTimer=0,transitionDirection=1,transitionText="GAME OVER",isTransitioning=!1,transitionCallback1=null,transitionCallback2=null,transitionReverseOnHalf=!1,tutorialTimer=0,tutorialPrevTimer=0,skinButtonBlocks=[],skinScreenVisible=!1,titleTimer=-1,resetTitleNextFrame=!0,titleLastRender=0,currentTouches=[],doRefreshAfterDie=!1,pressedKeys=[],camPosOffset=[0,0],camRotOffset=0,camShakeForces=[],socialOpacity=0,socialOTarget=0,socialIsReady=!1,socialHovering=!1,lastHonkTime=0,honkSfx=null,skipDeathTransition=!1,allowSkipDeathTransition=!1,deathTransitionTimeout=null,servers=[],donePing=!1,serversRequestDone=!1,doConnectAfterServersGet=!1,thisServerAvgPing=0,thisServerDiffPing=0,thisServerLastPing=0,lastPingTime=0,waitingForPing=!1,serversJsonGetTime=0,closeNotification=null,connectionLostNotification=null,lastMyPosSetClientSideTime=0,lastMyPosServerSideTime=0,lastMyPosSetValidClientSideTime=0,lastMyPosHasBeenConfirmed=!1,uiElems=[],uglyMode=!1,hasReceivedChunkThisGame=!1,didSendSecondReady=!1,lastStatBlocks=0,lastStatKills=0,lastStatLbRank=0,lastStatAlive=0,lastStatNo1Time=0,lastStatDeathType=0,lastStatKiller="",bestStatBlocks=0,bestStatKills=0,bestStatLbRank=0,bestStatAlive=0,bestStatNo1Time=0,lastStatTimer=0,lastStatCounter=0,lastMousePos=[0,0],mouseHidePos=[0,0],preventTeamServerConnection=!1,didConfirmOpenInApp=!1,aiptag=window.aiptag=window.aiptag||{};aiptag.cmd=aiptag.cmd||[],aiptag.cmd.display=aiptag.cmd.display||[],aiptag.cmd.player=aiptag.cmd.player||[],aiptag.gdprConsent="true"==localStorage.hasAdsConsent;var bannerAdsUseCurse=!1,receiveAction={UPDATE_BLOCKS:1,PLAYER_POS:2,FILL_AREA:3,SET_TRAIL:4,PLAYER_DIE:5,CHUNK_OF_BLOCKS:6,REMOVE_PLAYER:7,PLAYER_NAME:8,MY_SCORE:9,MY_RANK:10,LEADERBOARD:11,MAP_SIZE:12,YOU_DED:13,MINIMAP:14,PLAYER_SKIN:15,EMPTY_TRAIL_WITH_LAST_POS:16,READY:17,PLAYER_HIT_LINE:18,REFRESH_AFTER_DIE:19,PLAYER_HONK:20,PONG:21,UNDO_PLAYER_DIE:22,TEAM_LIFE_COUNT:23},sendAction={UPDATE_DIR:1,SET_USERNAME:2,SKIN:3,READY:4,REQUEST_CLOSE:5,HONK:6,PING:7,REQUEST_MY_TRAIL:8,MY_TEAM_URL:9,SET_TEAM_USERNAME:10,VERSION:11,PATREON_CODE:12},teamSendAction={REQUEST_TEAM_ID:1,MY_USERNAME:2,START_GAME:3,PING_DATA:4,SEND_IPS:5,SET_TEAM_USERNAME:6},teamReceiveAction={URL:1,BECOME_HOST:2,ADD_PLAYER:3,REMOVE_PLAYER:4,REQUEST_IPS:5,GAME_START:6,TEAM_IS_FULL:7,SET_TEAM_USERNAME:8},colors={grey:{BG:"#3a342f",brighter:"#4e463f",darker:"#2d2926",diagonalLines:"#c7c7c7"},red:{brighter:"#a22929",darker:"#7b1e1e",slightlyBrighter:"#af2c2c",pattern:"#8c2222",patternEdge:"#631717",boundsDark:"#420707",boundsBright:"#4c0808"},red2:{brighter:"#E3295E",darker:"#B3224B",slightlyBrighter:"#F02B63",pattern:"#CC2554",patternEdge:"#9C1C40"},pink:{brighter:"#A22974",darker:"#7A1F57",pattern:"#8A2262",patternEdge:"#5E1743",slightlyBrighter:"#B02C7E"},pink2:{brighter:"#7D26EF",darker:"#5E1DBA",pattern:"#6A21D1",patternEdge:"#4C1896",slightlyBrighter:"#882DFF"},purple:{brighter:"#531880",darker:"#391058",pattern:"#4b1573",patternEdge:"#3b115a",slightlyBrighter:"#5a198c"},blue:{brighter:"#27409c",darker:"#1d3179",pattern:"#213786",patternEdge:"#1b2b67",slightlyBrighter:"#2a44a9"},blue2:{brighter:"#3873E0",darker:"#2754A3",pattern:"#2F64BF",patternEdge:"#1F4587",slightlyBrighter:"#3B79ED"},green:{brighter:"#2ACC38",darker:"#1C9626",pattern:"#24AF30",patternEdge:"#178220",slightlyBrighter:"#2FD63D"},green2:{brighter:"#1e7d29",darker:"#18561f",pattern:"#1a6d24",patternEdge:"#14541c",slightlyBrighter:"#21882c"},leaf:{brighter:"#6a792c",darker:"#576325",pattern:"#5A6625",patternEdge:"#454F1C",slightlyBrighter:"#738430"},yellow:{brighter:"#d2b732",darker:"#af992b",pattern:"#D1A932",patternEdge:"#B5922B",slightlyBrighter:"#e6c938"},orange:{brighter:"#d06c18",darker:"#ab5a15",pattern:"#AF5B16",patternEdge:"#914A0F",slightlyBrighter:"#da7119"},gold:{brighter:"#F6B62C",darker:"#F7981B",pattern:"#DC821E",patternEdge:"#BD6B0E",slightlyBrighter:"#FBDF78",bevelBright:"#F9D485"}},titleLines=[{line:[[86,82],[50,57,25,99,65,105],[110,110,80,158,42,129]],speed:1,offset:0,posOffset:[16,0]},{line:[[129,74],[129,169]],speed:1,offset:.7,posOffset:[10,0]},{line:[[129,106],[129,63,191,63,191,106],[191,149,129,149,129,106]],speed:1,offset:1.2,posOffset:[10,0]},{line:[[236,41],[236,138]],speed:2,offset:.7,posOffset:[0,0]},{line:[[276,41],[276,45]],speed:3,offset:.4,posOffset:[0,0]},{line:[[276,74],[276,138]],speed:2,offset:0,posOffset:[0,0]},{line:[[318,74],[366,138]],speed:2,offset:.5,posOffset:[-5,0]},{line:[[318,138],[366,74]],speed:4,offset:0,posOffset:[-5,0]},{line:[[415,136],[415,134,419,134,419,136],[419,138,415,138,415,136]],speed:1,offset:0,posOffset:[-25,0]},{line:[[454,41],[454,45]],speed:3,offset:.8,posOffset:[-25,0]},{line:[[454,74],[454,138]],speed:2,offset:.5,posOffset:[-25,0]},{line:[[500,106],[500,63,562,63,562,106],[562,149,500,149,500,106]],speed:1,offset:.2,posOffset:[-38,0]}];function addSocketWrapper(){var a,i;"undefined"==typeof WebSocket||0<(a=parseInt(localStorage.simulatedLatency)/2)&&(i=WebSocket,WrappedWebSocket=function(e){var t=new i(e);t.binaryType="arraybuffer",this.onclose=function(){},this.onopen=function(){},this.onmessage=function(){};var n=this;t.onclose=function(){window.setTimeout(function(){n.onclose()},a)},t.onopen=function(){window.setTimeout(function(){n.onopen()},a)},t.onmessage=function(e){window.setTimeout(function(){n.onmessage(e)},a)},this.send=function(e){window.setTimeout(function(){t.send(e)},a)},this.close=function(){window.setTimeout(function(){t.close()},a)}},window.WebSocket=WrappedWebSocket.bind())}function simpleRequest(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState==XMLHttpRequest.DONE&&200==n.status&&null!=t&&t(n.responseText)},n.open("GET",e,!0),n.send()}function trackGameStart(){}function countPlayGame(){var e=0;null!==localStorage.getItem("totalGamesPlayed")&&(e=localStorage.totalGamesPlayed),lsSet("totalGamesPlayed",++e)}function getServers(){simpleRequest("/json/servers.2.json",function(e){serversJsonGetTime=Date.now();var t=JSON.parse(e),n=t.locations;for(var a in servers=[],n){var i=generateServerLocation(n[a]);servers.push(i),serversRequestDone=!0}teamServers=t.teamServers;for(var o=0;o<teamServers.length;o++)teamServers[o].active&&activeTeamServers.push(teamServers[o]);retentionSamples=t.retentionSamples,doConnectAfterServersGet&&(doConnectAfterServersGet=!1,doConnect()),teamDoConnectAfterServersGet&&(teamDoConnectAfterServersGet=!1,teamDoConnect());var s,r=randFromArray(t.mobileAdData.promoBannerUrls);window.location.hash.startsWith("#forcepromo=")&&(r=window.location.hash.substr(12)),-1==r.indexOf("http://")&&-1==r.indexOf("https://")&&(r="https://splix.io/banners/"+r+"/index.html"),(testPatreonAdsAllowed()||t.mobileAdData.showPromoForPatreonUsers)&&r&&((s=document.getElementById("promoboxFrame")).onload=function(){window.addEventListener("message",function(e){e.data.promoHeight&&(console.log("get promoHeight",e.data.promoHeight),document.getElementById("promobox").style.opacity=1,s.height=Math.min(300,e.data.promoHeight))}),s.contentWindow.postMessage("requestHeight","*")},s.src=r)})}function generateServerLocation(e){return{pingUrlV4:e.pingIpv4+"/ping",pingUrlV6:e.pingIpv6+"/ping",gamemodes:e.gamemodes,loc:e.loc,locId:e.locId,ws:null,ws6:null,pingTries:0,pingTries6:0,avgPing:0,avgPing6:0,open:!1,open6:!1,initSocket:function(){this.connectionTries++,this.lastConnectionTry=Date.now(),null!==this.ws&&(this.ws.onmessage=null,this.ws.onopen=null,this.ws.onclose=null,this.ws.close(),this.pingTries=0,this.avgPing=0,this.lastPingTime=0,this.waitingForPing=!1),this.ws=new WebSocket(SECURE_WS+this.pingUrlV4),this.ws.binaryType="arraybuffer";var t=this;this.ws.onmessage=function(){var e;t.waitingForPing&&(e=Date.now()-t.lastPingTime,e+=10,t.avgPing=t.avgPing*t.pingTries+e,t.pingTries++,t.avgPing/=t.pingTries,t.lastPingTime=Date.now(),t.waitingForPing=!1,4<=t.pingTries&&(t.open=!1,t.ws.close()))},this.ws.onopen=function(){t.open=!0,t.connectedOnce=!0},this.ws.onclose=function(){t.open=!1}},initSocket6:function(){this.connectionTries6++,this.lastConnectionTry6=Date.now(),null!==this.ws6&&(this.ws6.onmessage=null,this.ws6.onopen=null,this.ws6.onclose=null,this.ws6.close(),this.pingTries6=0,this.avgPing6=0,this.lastPingTime6=0,this.waitingForPing6=!1),this.ws6=new WebSocket(SECURE_WS+this.pingUrlV6),this.ws6.binaryType="arraybuffer";var t=this;this.ws6.onmessage=function(){var e;t.waitingForPing6&&(e=Date.now()-t.lastPingTime6,t.avgPing6=t.avgPing6*t.pingTries6+e,t.pingTries6++,t.avgPing6/=t.pingTries6,t.lastPingTime6=Date.now(),t.waitingForPing6=!1,4<=t.pingTries6&&(t.open6=!1,t.ws6.close()))},this.ws6.onopen=function(){t.open6=!0,t.connectedOnce6=!0},this.ws6.onclose=function(){t.open6=!1}},lastPingTime:0,lastPingTime6:0,waitingForPing:!1,waitingForPing6:!1,ping:function(){if(!this.waitingForPing)return this.open&&this.ws&&this.ws.readyState==WebSocket.OPEN?(this.waitingForPing=!0,this.lastPingTime=Date.now(),this.ws.send(new Uint8Array([0])),4<=this.pingTries):this.testSuccessfulConnection();1e4<Date.now()-this.lastPingTime&&this.initSocket()},ping6:function(){if(!this.waitingForPing6)return this.open6&&this.ws6&&this.ws6.readyState==WebSocket.OPEN?(this.waitingForPing6=!0,this.lastPingTime6=Date.now(),this.ws6.send(new Uint8Array([0])),4<=this.pingTries6):this.testSuccessfulConnection();1e4<Date.now()-this.lastPingTime6&&this.initSocket6()},connectedOnce:!1,connectedOnce6:!1,connectionTries:0,connectionTries6:0,lastConnectionTry:Date.now(),lastConnectionTry6:Date.now(),testSuccessfulConnection:function(){return!(!this.connectedOnce&&!this.connectedOnce6)||(3<this.connectionTries||(Date.now()-this.lastConnectionTry<5e3||this.initSocket(),!1))},testSuccessfulConnection6:function(){return!(!this.connectedOnce&&!this.connectedOnce6)||(3<this.connectionTries6||(Date.now()-this.lastConnectionTry6<5e3||this.initSocket6(),!1))}}}function startPingServers(){for(var e=0;e<servers.length;e++){var t=servers[e];t.initSocket(),t.initSocket6()}}function pingServers(){if(donePing=!0,0<servers.length)for(var e=0;e<servers.length;e++){var t=servers[e];t.ping()||(donePing=!1),t.ping6()||(donePing=!1)}else donePing=!1;donePing&&"Teams"==selectedGamemode&&teamSendPingData()}function getServer(e,t){var n,a,i,o,s;console.log("searching for best server"),void 0===e&&(e=-1),void 0===t&&(t=!0);var r=null,l=null;if(t&&location.hash){if(0===location.hash.indexOf("#ip-"))return console.log("ip provided in url, using "+location.hash),{ip:SECURE_WS+location.hash.substring(4),ping:30};if(0===location.hash.indexOf("#team-")&&"Teams"==selectedGamemode){if(testExistingTeamHash())return console.log("disconnect from previous teams session was unexpected, using the ip from the old teams session"),{ip:SECURE_WS+localStorage.lastTeamIp,ping:30}}else{if(servers.length<=0)return console.log("servers length <= 0, unable to connect (1)"),null;var c=selectedGamemode.toLowerCase();"normal"==c&&(c="default");for(var d=0;d<servers.length;d++)for(var m=servers[d],u=0;u<m.gamemodes.length;u++)if((o=m.gamemodes[u]).gm==c)for(i=0;i<o.versions.length;i++)if((s=o.versions[i]).ver==COMPATIBLE_CLIENT_VERSION)for(var p=s.lobbies,h=0;h<p.length;h++)if((a=p[h]).hash==location.hash.substring(1)){r=a,l=m;break}}}if(null===r){l=null;var g=1/0;if(servers.length<=0)return console.log("servers length <= 0, unable to connect (2)"),null;for(console.log("determining what the best location is"),u=0;u<servers.length;u++){if(n=servers[u],0<=e&&n.locId==e){l=n;break}n.avgPing<g&&0<n.pingTries&&(g=n.avgPing,l=n),n.avgPing6<g&&0<n.pingTries6&&(g=n.avgPing6,l=n)}null===l&&(console.log("Couldn't determine best location, picking a random one"),l=randFromArray(servers)),console.log("found location is "+l.loc);var f=null;console.log("searching for lobby group in this location with version "+COMPATIBLE_CLIENT_VERSION+" and gamemode "+selectedGamemode);var T={Normal:"default",Teams:"teams"};for(u=0;u<l.gamemodes.length;u++)if((o=l.gamemodes[u]).gm==T[selectedGamemode])for(console.log("found gamemode",o.gm),i=0;i<o.versions.length;i++)if((s=o.versions[i]).ver==COMPATIBLE_CLIENT_VERSION){f=s.lobbies;break}if(null===f||f.length<=0)return console.log(f),console.log("lobbiesGroup not found or lobbiesGroup.length <= 0, couldn't find server"),null;r=randFromArray(f),console.log("a lobby was found:",r)}var y,v,S=location.href;t&&(location.hash||S.lastIndexOf("#")==S.length-1)&&(location.hash=r.hash),v=0<l.pingTries6&&(l.avgPing6<l.avgPing||l.pingTries<=0)?(y=r.ipv6,l.avgPing6):(y=r.ipv4,l.avgPing);var C=IS_SECURE?r.securePort:r.port;return{ip:SECURE_WS+y+"/splix"+C,ip4:r.ipv4+"/splix"+C,ip6:r.ipv6+"/splix"+C,ping:v,locId:l.locId}}function getBlock(e,t,n){var a;void 0===n&&(n=blocks);for(var i=0;i<n.length;i++)if((a=n[i]).x==e&&a.y==t)return a;return a={x:e,y:t,currentBlock:-1,nextBlock:-1,animDirection:0,animProgress:0,animDelay:0,lastSetTime:Date.now(),setBlockId:function(e,t){var n,a;this.lastSetTime=Date.now(),!1===t?(this.currentBlock=this.nextBlock=e,this.animDirection=0,this.animProgress=1):(void 0===t&&(t=0),this.animDelay=t,n=e==this.currentBlock,a=e==this.nextBlock,n&&a&&-1==this.animDirection&&(this.animDirection=1),n&&!a&&(this.animDirection=1,this.nextBlock=this.currentBlock),!n&&a&&1==this.animDirection&&(this.animDirection=-1),n||a||(this.nextBlock=e,this.animDirection=-1))}},n.push(a),a}function getPlayer(e,t){var n;void 0===t&&(t=players);for(var a=0;a<t.length;a++)if((n=t[a]).id==e)return n;return n={id:e,pos:[0,0],drawPos:[-1,-1],drawPosSet:!1,serverPos:[0,0],dir:0,isMyPlayer:0===e,isDead:!1,deathWasCertain:!1,didUncertainDeathLastTick:!1,isDeadTimer:0,uncertainDeathPosition:[0,0],die:function(e){if(e=!!e,this.isDead)this.deathWasCertain=e||this.deathWasCertain;else if(e||!this.didUncertainDeathLastTick){e||(this.didUncertainDeathLastTick=!0,this.uncertainDeathPosition=[this.pos[0],this.pos[1]]),this.isDead=!0,this.deathWasCertain=e,this.deadAnimParts=[0],this.isDeadTimer=0,this.isMyPlayer&&doCamShakeDir(this.dir);for(var t=0;;){if((t+=.4*Math.random()+.5)>=2*Math.PI){this.deadAnimParts.push(2*Math.PI);break}this.deadAnimParts.push(t),this.deadAnimPartsRandDist.push(Math.random())}}},undoDie:function(){this.isDead=!1},deadAnimParts:[],deadAnimPartsRandDist:[],addHitLine:function(e,t){this.hitLines.push({pos:e,vanishTimer:0,color:t})},hitLines:[],doHonk:function(e){this.honkTimer=0,this.honkMaxTime=e,"joris"==this.name.toLowerCase()&&(null==honkSfx&&(honkSfx=new Audio("/honk.mp3")),honkSfx.play())},moveRelativeToServerPosNextFrame:!1,lastServerPosSentTime:0,honkTimer:0,honkMaxTime:0,trails:[],name:"",skinBlock:0,lastBlock:null,hasReceivedPosition:!1},t.push(n),n.isMyPlayer&&(myPlayer=n),n}function lsSet(e,t){try{return localStorage.setItem(e,t),!0}catch(e){return!1}}function checkUsername(e){var t,n=e.toLowerCase();"denniskoe"==n?(t=document.body.style).webkitFilter=t.filter="contrast(200%) hue-rotate(90deg) invert(100%)":"kwebbelkop"==n?(lsSet("skinColor",12),lsSet("skinPattern",18),updateSkin()):"jelly"==n?(lsSet("skinColor",8),lsSet("skinPattern",19),updateSkin()):-1<n.indexOf("masterov")||0===n.indexOf("[mg]")||0===n.indexOf("(mg)")?(lsSet("skinColor",12),lsSet("skinPattern",20),updateSkin()):"farsattack"==n?(lsSet("skinColor",8),lsSet("skinPattern",21),updateSkin()):0===n.indexOf("[am]")||0===n.indexOf("(am)")?(lsSet("skinColor",11),lsSet("skinPattern",23),updateSkin()):"hetgames"==n?(lsSet("skinColor",1),lsSet("skinPattern",24),updateSkin()):0===n.indexOf("[gym]")||0===n.indexOf("(gym)")?(lsSet("skinColor",4),lsSet("skinPattern",25),updateSkin()):"luh"==n&&(lsSet("skinColor",12),lsSet("skinPattern",26),updateSkin())}function sendName(){var e=nameInput.value;null!=e&&""!==e&&""!==e.trim()&&wsSendMsg(sendAction.SET_USERNAME,e)}function nameInputOnChange(){lsSet("name",nameInput.value),teamSendPlayerName()}function sendTeamName(){var e;"Teams"!=selectedGamemode||!teamBeginUIIsHost||null!=(e=teamNameInput.value)&&""!==e&&""!==e.trim()&&wsSendMsg(sendAction.SET_TEAM_USERNAME,e)}function sendVersion(){wsSendMsg(sendAction.VERSION,{type:0,ver:CLIENT_VERSION})}function sendSkin(){var e=localStorage.getItem("skinColor");null===e&&(e=0);var t=localStorage.getItem("skinPattern");null===t&&(t=0),wsSendMsg(sendAction.SKIN,{blockColor:e,pattern:t})}function sendTeamUrl(){"Teams"==selectedGamemode&&wsSendMsg(sendAction.MY_TEAM_URL,teamShareUrl)}function sendPatreonCode(){""!==localStorage.patreonLastSplixCode&&void 0!==localStorage.patreonLastSplixCode&&wsSendMsg(sendAction.PATREON_CODE,localStorage.patreonLastSplixCode)}function parseDirKey(e){var t=!1;return 38!=e&&87!=e&&56!=e&&73!=e||(sendDir(3),t=!0),37!=e&&65!=e&&52!=e&&74!=e||(sendDir(2),t=!0),39!=e&&68!=e&&54!=e&&76!=e||(sendDir(0),t=!0),40!=e&&83!=e&&50!=e&&75!=e||(sendDir(1),t=!0),80==e&&(sendDir(4),t=!0),32!=e&&53!=e||(honkStart(),t=!0),13==e&&(doSkipDeathTransition(),t=!0),t}addSocketWrapper(),getServers();var lastSendDir=-1,lastSendDirTime=0;function sendDir(e,t){if(!ws||!myPos)return!1;if(!myPlayer)return!1;if(e==lastSendDir&&Date.now()-lastSendDirTime<.7/GLOBAL_SPEED)return!1;if(lastSendDir=e,lastSendDirTime=Date.now(),myPlayer.dir==e)return addSendDirQueue(e,t),!1;if(0===e&&2==myPlayer.dir||2==e&&0===myPlayer.dir||1==e&&3==myPlayer.dir||3==e&&1==myPlayer.dir)return addSendDirQueue(e,t),!1;mouseHidePos=[lastMousePos[0],lastMousePos[1]],document.body.style.cursor="none";var n=1==myPlayer.dir||3==myPlayer.dir,a=myPos[n?1:0],i=[myPos[0],myPos[1]],o=Math.round(a);if(i[n?1:0]=o,0===myPlayer.dir&&i[0]<=lastChangedDirPos[0]||1==myPlayer.dir&&i[1]<=lastChangedDirPos[1]||2==myPlayer.dir&&i[0]>=lastChangedDirPos[0]||3==myPlayer.dir&&i[1]>=lastChangedDirPos[1])return addSendDirQueue(e,t),!1;var s=!1,r=a-Math.floor(a);return myPlayer.dir<=1?r<.45&&(s=!0):myPlayer.dir<=3&&!(.55<r)||(s=!0),s?changeMyDir(e,i):(myNextDir=e,changeDirAt=o,changeDirAtIsHorizontal=n,lastChangedDirPos=[i[0],i[1]]),lastMyPosSetClientSideTime=Date.now(),lastMyPosHasBeenConfirmed&&(lastMyPosSetValidClientSideTime=Date.now()),lastMyPosHasBeenConfirmed=!1,wsSendMsg(sendAction.UPDATE_DIR,{dir:e,coord:i}),!0}var sendDirQueue=[];function addSendDirQueue(e,t){!t&&sendDirQueue.length<3&&sendDirQueue.push({dir:e,addTime:Date.now()})}function changeMyDir(e,t,n,a){myPlayer.dir=myNextDir=e,myPlayer.pos=[t[0],t[1]],lastChangedDirPos=[t[0],t[1]],void 0===n&&(n=!0),void 0===a&&(a=!0),n&&trailPush(myPlayer),a&&lastClientsideMoves.push({dir:e,pos:t})}function startRequestMyTrail(){isRequestingMyTrail=!0,trailPushesDuringRequest=[],wsSendMsg(sendAction.REQUEST_MY_TRAIL)}function trailPush(e,t){var n,a;0<e.trails.length&&(0<(n=e.trails[e.trails.length-1].trail).length&&((a=n[n.length-1])[0]==e.pos[0]&&a[1]==e.pos[1]||(t=void 0===t?[e.pos[0],e.pos[1]]:[t[0],t[1]],n.push(t),e.isMyPlayer&&isRequestingMyTrail&&trailPushesDuringRequest.push(t))))}function honkStart(){honkStartTime=Date.now()}function honkEnd(){var e=Date.now();if(lastHonkTime<e){var t=clamp(t=e-honkStartTime,0,1e3);lastHonkTime=e+t,t=iLerp(0,1e3,t),t*=255,t=Math.floor(t),wsSendMsg(sendAction.HONK,t);for(var n=0;n<players.length;n++){var a=players[n];a.isMyPlayer&&a.doHonk(Math.max(70,t))}}}function onOpen(){isConnecting=!1,sendVersion(),sendPatreonCode(),sendName(),sendSkin(),sendTeamUrl(),sendTeamName(),wsSendMsg(sendAction.READY),playingAndReady&&onConnectOrMiddleOfTransition(),trackGameStart(),countPlayGame(),wsOnOpenTime=Date.now()}function onConnectOrMiddleOfTransition(){hideSkinScreen(),hideBeginShowMain(),destroyBanners(),skipChangeToNormalOnce=!0,teamWsClose()}function hideBeginShowMain(){hideBegin(),showMainCanvas()}function hideBegin(){beginScreen.style.display="none",beginScreenVisible=!1}function showMainCanvas(){playUI.style.display=null,mainCanvas.style.display=null,"ontouchstart"in window&&(touchControlsElem.style.display=null),myNameAlphaTimer=0,setNotification("")}function setNotification(e){notificationElem.innerHTML=e,notificationElem.style.display=e?null:"none"}function showBegin(){beginScreen.style.display=null,beginScreenVisible=!0,nameInput.focus(),setAdBoxLeft()}function hideMainCanvas(){playUI.style.display="none",mainCanvas.style.display="none",touchControlsElem.style.display="none"}function showSkinScreen(){skinScreenVisible=!0,skinScreen.style.display=null}function hideSkinScreen(){skinScreenVisible=!1,skinScreen.style.display="none"}function openSkinScreen(){hideBegin(),showSkinScreen()}function showBeginHideMainCanvas(){showBegin(),hideMainCanvas()}function showBeginHideSkin(){showBegin(),hideSkinScreen()}function onClose(){ws&&ws.readyState==WebSocket.OPEN&&ws.close(),playingAndReady?closedBecauseOfDeath||(doTransition("",!1,resetAll),setNotification("The connection was lost :/")):isTransitioning?showCouldntConnectAfterTransition=!0:couldntConnect()&&showBeginHideMainCanvas(),ws=null,isConnecting=!1,"Teams"!=selectedGamemode||testTeamWsConnection()||teamDoConnect()}function couldntConnect(){var e=Date.now()-serversJsonGetTime;if(resetAll(),5<(e/=1e3))return doConnectAfterServersGet=!0,console.log("requesting server list again"),getServers(),!1;setNotification("Couldn't connect to the server :/");var t=new Error("couldntConnectError");return console.log(t.stack),isTransitioning=!0}var isConnectingWithTransition=!(window.onload=function(){mainCanvas=document.getElementById("mainCanvas"),ctx=mainCanvas.getContext("2d"),minimapCanvas=document.getElementById("minimapCanvas"),minimapCtx=minimapCanvas.getContext("2d"),linesCanvas=document.createElement("canvas"),linesCtx=linesCanvas.getContext("2d"),tempCanvas=document.createElement("canvas"),tempCtx=tempCanvas.getContext("2d"),transitionCanvas=document.getElementById("transitionCanvas"),tCtx=transitionCanvas.getContext("2d"),tutorialCanvas=document.getElementById("tutorialCanvas"),tutCtx=tutorialCanvas.getContext("2d"),tutorialText=document.getElementById("tutorialText"),touchControlsElem=document.getElementById("touchControls"),notificationElem=document.getElementById("notification"),skinScreen=document.getElementById("skinScreen"),skinCanvas=document.getElementById("skinScreenCanvas"),skinCtx=skinCanvas.getContext("2d"),lastStatValueElem=document.getElementById("lastStatsRight"),bestStatValueElem=document.getElementById("bestStatsRight"),joinButton=document.getElementById("joinButton"),teamBox=document.getElementById("teamBox"),teamBoxLoading=document.getElementById("teamBoxLoading"),teamBoxLoaded=document.getElementById("teamBoxLoaded"),teamShareLink=document.getElementById("teamShareLink"),teamShareCopyBtn=document.getElementById("teamShareCopyBtn"),qualityText=document.getElementById("qualityText"),uglyText=document.getElementById("uglyText"),teamPlayersList=document.getElementById("teamPlayersList"),teamNameH=document.getElementById("teamNameH"),teamNameInput=document.getElementById("teamNameInput"),lifeBox=document.getElementById("lifeBox"),adBox=document.getElementById("adbox"),adBox2=document.getElementById("adbox2"),window.onkeydown=function(e){var t,n=e.keyCode;pressedKeys.indexOf(n)<0&&(pressedKeys.push(n),t=parseDirKey(n),79==n&&myPos&&(leaderboardHidden=!leaderboardHidden,setLeaderboardVisibility(),lsSet("leaderboardHidden",leaderboardHidden)),t&&playingAndReady&&e.preventDefault())},window.onkeyup=function(e){var t=e.keyCode,n=pressedKeys.indexOf(t);pressedKeys.splice(n,1),32!=t&&53!=t||honkEnd();for(var a=0;a<pressedKeys.length;a++)parseDirKey(pressedKeys[a])},window.addEventListener("blur",function(e){pressedKeys=[]},!1),bindSwipeEvents(),window.oncontextmenu=function(e){return"embed"==e.target.nodeName.toLowerCase()||(e.preventDefault(),!1)},myScoreElem=document.getElementById("blockCaptureCount"),myRealScoreElem=document.getElementById("score"),myKillsElem=document.getElementById("myKills"),myRankElem=document.getElementById("myRank"),totalPlayersElem=document.getElementById("totalPlayers"),leaderboardElem=document.createElement("tbody");var e,t,n,a=document.createElement("table");a.appendChild(leaderboardElem),(leaderboardDivElem=document.getElementById("leaderboard")).appendChild(a),uiElems.push(leaderboardDivElem),miniMapPlayer=document.getElementById("miniMapPlayer"),beginScreen=document.getElementById("beginScreen"),playUI=document.getElementById("playUI"),uiElems.push(document.getElementById("scoreBlock")),uiElems.push(document.getElementById("miniMap")),prerollElem=document.getElementById("preroll"),(appLinksElem=document.getElementById("appLinks")).style.opacity=0,nameInput=document.getElementById("nameInput"),localStorage.name&&(nameInput.value=localStorage.name),localStorage.teamName&&(teamNameInput.value=localStorage.teamName),nameInput.focus(),localStorage.autoConnect&&doConnect(),(formElem=document.getElementById("nameForm")).onsubmit=function(){if("Teams"==selectedGamemode)teamWsSendMsg(teamSendAction.START_GAME);else try{connectWithTransition()}catch(e){console.log("Error",e.stack),console.log("Error",e.name),console.log("Error",e.message),setNotification("An error occurred :/")}return!1},window.addEventListener("click",showCursor),window.addEventListener("mousemove",function(e){var t=(lastMousePos=[e.screenX,e.screenY])[0]-mouseHidePos[0],n=lastMousePos[1]-mouseHidePos[1];15<Math.sqrt(Math.pow(t,2)+Math.pow(n,2))&&showCursor()}),qualityText.onclick=toggleQuality,uglyText.onclick=toggleUglyMode,setQuality(),setUglyText(),initTutorial(),initSkinScreen(),initTitle(),initGameModeUI(),setLeaderboardVisibility(),0===location.hash.indexOf("#pledged")&&("action"in(e=parseQuery(location.href))&&-1==["update","create"].indexOf(e.action)||setPatreonOverlay(!0)),requestPatreonPledgeData(),localStorage.refreshDuringAd&&(initVideoAdsScript(),requestCanRunAds()),testPatreonAdsAllowed()&&(setUpAdBoxContent(),bannerAdsUseCurse?(n=document.createElement("script"),t=new Date,n.id="factorem",n.src="//cdm.cursecdn.com/js/splix/cdmfactorem_min.js?sec=home&misc="+t.getTime(),n.type="text/javascript",document.head.appendChild(n)):((n=document.createElement("script")).src="//api.adinplay.com/libs/aiptag/pub/JTE/splix.io/tag.min.js",n.type="text/javascript",document.head.appendChild(n),refreshBanner())),(socialElem=document.getElementById("social")).addEventListener("mouseenter",function(){socialHovering=!0,testSocialTarget()}),socialElem.addEventListener("mouseleave",function(){socialHovering=!1,testSocialTarget()}),bestStatBlocks=Math.max(bestStatBlocks,localStorage.getItem("bestStatBlocks")),bestStatKills=Math.max(bestStatKills,localStorage.getItem("bestStatKills")),bestStatLbRank=Math.max(bestStatLbRank,localStorage.getItem("bestStatLbRank")),bestStatAlive=Math.max(bestStatAlive,localStorage.getItem("bestStatAlive")),bestStatNo1Time=Math.max(bestStatNo1Time,localStorage.getItem("bestStatNo1Time")),window.requestAnimationFrame(loop);var i=IS_DEV_BUILD?" (dev build)":"";console.log("%c splix.io %c\n\n\nversion "+JS_VERSION+" loaded"+i,"color: #a22929; font-size: 50px; font-family: arial; text-shadow: 1px 1px #7b1e1e, 2px 2px #7b1e1e;","")});function connectWithTransition(e){isConnectingWithTransition||isWaitingForAd||(isConnectingWithTransition=!0,doConnect(e)&&(doTransition("",!1,function(){playingAndReady||(isTransitioning=!1),(showCouldntConnectAfterTransition?couldntConnect:onConnectOrMiddleOfTransition)(),showCouldntConnectAfterTransition=!1}),nameInput.blur(),checkUsername(nameInput.value)),isConnectingWithTransition=!1)}var isConnecting=!1;function doConnect(e){if(ws||isConnecting||isTransitioning)return!1;if(canRunAds&&!e&&testPatreonAdsAllowed()){var t=getAdCounter(),n=localStorage.lastAdTime,n=parseInt(n);if(n=Date.now()-n,1==t||!isNaN(n)&&3e5<n)return displayAd(),!1;countAd()}closedBecauseOfDeath=showCouldntConnectAfterTransition=!(isConnecting=!0);var a=getServer();return a?(thisServerAvgPing=thisServerLastPing=a.ping,console.log("connecting to "+a.ip+"..."),(ws=new WebSocket(a.ip)).binaryType="arraybuffer",ws.onmessage=function(e){ws==this&&onMessage(e)},ws.onclose=function(e){ws==this&&onClose(e)},ws.onopen=function(e){ws==this&&onOpen(e)},!0):(onClose(),!1)}function onMessage(e){var t,n,a,i,o,s,r,l,c,d,m,u,p,h,g,f,T,y,v,S,C,P,x,E=new Uint8Array(e.data);if(E[0]==receiveAction.UPDATE_BLOCKS&&(u=bytesToInt(E[1],E[2]),t=bytesToInt(E[3],E[4]),n=E[5],getBlock(u,t).setBlockId(n)),E[0]==receiveAction.PLAYER_POS&&(u=bytesToInt(E[1],E[2]),t=bytesToInt(E[3],E[4]),(g=getPlayer(h=bytesToInt(E[5],E[6]))).hasReceivedPosition=!0,g.moveRelativeToServerPosNextFrame=!0,g.lastServerPosSentTime=Date.now(),lastMyPosHasBeenConfirmed=!0,s=E[7],r=[u,t],l=[u,t],c=0,(g.isMyPlayer||50<thisServerAvgPing)&&(c=thisServerAvgPing/2*GLOBAL_SPEED),movePos(l,s,c),d=!0,g.isMyPlayer?(lastMyPosServerSideTime=Date.now(),(g.dir==s||myNextDir==s)&&Math.abs(l[0]-g.pos[0])<1&&Math.abs(l[1]-g.pos[1])<1&&(d=!1),0<lastClientsideMoves.length&&((m=lastClientsideMoves.shift()).dir==s&&m.pos[0]==r[0]&&m.pos[1]==r[1]?d=!1:lastClientsideMoves=[]),4!=g.dir&&4!=s||(d=!0),d&&(changeMyDir(myNextDir=s,r,!1,!1),startRequestMyTrail(),sendDirQueue=[]),g.serverPos=[l[0],l[1]],g.serverDir=s,removeBlocksOutsideViewport(g.pos)):g.dir=s,d&&(g.pos=l,8<E.length&&(1==E[8]?trailPush(g,r):g.trails.push({trail:[],vanishTimer:0}))),g.drawPosSet||(g.drawPos=[g.pos[0],g.pos[1]],g.drawPosSet=!0)),E[0]==receiveAction.FILL_AREA&&fillArea(u=bytesToInt(E[1],E[2]),t=bytesToInt(E[3],E[4]),a=bytesToInt(E[5],E[6]),i=bytesToInt(E[7],E[8]),n=E[9],E[10]),E[0]==receiveAction.SET_TRAIL){g=getPlayer(h=bytesToInt(E[1],E[2]));for(var A,I=[],b=!1,k=3;k<E.length;k+=4){var w=[bytesToInt(E[k],E[k+1]),bytesToInt(E[k+2],E[k+3])];I.push(w)}if(g.isMyPlayer)if(skipTrailRequestResponse)skipTrailRequestResponse=!1,trailPushesDuringRequest=[];else{if(isRequestingMyTrail){for(b=!(isRequestingMyTrail=!1),k=0;k<trailPushesDuringRequest.length;k++)I.push(trailPushesDuringRequest[k]);trailPushesDuringRequest=[]}0<g.trails.length&&g.trails[g.trails.length-1].trail.length<=0&&0<I.length&&startRequestMyTrail()}b&&(0<g.trails.length?((A=g.trails[g.trails.length-1]).trail=I,A.vanishTimer=0):b=!1),b||g.trails.push({trail:I,vanishTimer:0})}if(E[0]==receiveAction.EMPTY_TRAIL_WITH_LAST_POS&&(0<(g=getPlayer(h=bytesToInt(E[1],E[2]))).trails.length&&(0<(p=g.trails[g.trails.length-1].trail).length&&(u=bytesToInt(E[3],E[4]),t=bytesToInt(E[5],E[6]),p.push([u,t]))),g.isMyPlayer&&isRequestingMyTrail&&(skipTrailRequestResponse=!0),g.trails.push({trail:[],vanishTimer:0})),E[0]==receiveAction.PLAYER_DIE&&(g=getPlayer(h=bytesToInt(E[1],E[2])),3<E.length&&(u=bytesToInt(E[3],E[4]),t=bytesToInt(E[5],E[6]),g.pos=[u,t]),g.die(!0)),E[0]==receiveAction.CHUNK_OF_BLOCKS){for(u=bytesToInt(E[1],E[2]),t=bytesToInt(E[3],E[4]),a=bytesToInt(E[5],E[6]),i=bytesToInt(E[7],E[8]),k=9,o=u;o<u+a;o++)for(var D=t;D<t+i;D++)getBlock(o,D).setBlockId(E[k],!1),k++;hasReceivedChunkThisGame||(hasReceivedChunkThisGame=!0,wsSendMsg(sendAction.READY),didSendSecondReady=!0)}if(E[0]==receiveAction.REMOVE_PLAYER)for(h=bytesToInt(E[1],E[2]),k=players.length-1;0<=k;k--)h==(g=players[k]).id&&players.splice(k,1);if(E[0]==receiveAction.PLAYER_NAME&&(h=bytesToInt(E[1],E[2]),f=Utf8ArrayToStr(B=E.subarray(3,E.length)),(g=getPlayer(h)).name=filter(f)),E[0]==receiveAction.MY_SCORE&&(T=bytesToInt(E[1],E[2],E[3],E[4]),y=0,5<E.length&&(y=bytesToInt(E[5],E[6])),realScoreStatTarget=(scoreStatTarget=T)+500*y,myKillsElem.innerHTML=y),E[0]==receiveAction.MY_RANK&&(myRank=bytesToInt(E[1],E[2]),myRankSent=!0,updateStats()),E[0]==receiveAction.LEADERBOARD){leaderboardElem.innerHTML="",totalPlayers=bytesToInt(E[1],E[2]),updateStats(),k=3;for(var M=1;!(k>=E.length);){var B,R=bytesToInt(E[k],E[k+1],E[k+2],E[k+3]),L=E[k+4],O=Utf8ArrayToStr(B=E.subarray(k+5,k+5+L)),N=document.createElement("tr");N.className="scoreRank";var _=document.createElement("td");_.innerHTML="#"+M,N.appendChild(_);var U=document.createElement("td");U.innerHTML=filter(htmlEscape(O)),N.appendChild(U);var W=document.createElement("td");W.innerHTML=R,N.appendChild(W),leaderboardElem.appendChild(N),k=k+5+L,M++}totalPlayers<30&&doRefreshAfterDie&&null===closeNotification&&(closeNotification=doTopNotification("This server is about to close, refresh to join a full server."))}if(E[0]==receiveAction.MAP_SIZE&&(mapSize=bytesToInt(E[1],E[2])),E[0]==receiveAction.YOU_DED){if(1<E.length)switch(lastStatBlocks=bytesToInt(E[1],E[2],E[3],E[4]),bestStatBlocks<lastStatBlocks&&lsSet("bestStatBlocks",bestStatBlocks=lastStatBlocks),lastStatKills=bytesToInt(E[5],E[6]),bestStatKills<lastStatKills&&lsSet("bestStatKills",bestStatKills=lastStatKills),((lastStatLbRank=bytesToInt(E[7],E[8]))<bestStatLbRank||bestStatLbRank<=0)&&0<lastStatLbRank&&lsSet("bestStatLbRank",bestStatLbRank=lastStatLbRank),lastStatAlive=bytesToInt(E[9],E[10],E[11],E[12]),bestStatAlive<lastStatAlive&&lsSet("bestStatAlive",bestStatAlive=lastStatAlive),lastStatNo1Time=bytesToInt(E[13],E[14],E[15],E[16]),bestStatNo1Time<lastStatNo1Time&&lsSet("bestStatNo1Time",bestStatNo1Time=lastStatNo1Time),lastStatDeathType=E[17],lastStatKiller="",document.getElementById("lastStats").style.display=null,document.getElementById("bestStats").style.display=null,lastStatTimer=lastStatCounter=0,lastStatValueElem.innerHTML=bestStatValueElem.innerHTML="",lastStatDeathType){case 1:18<E.length&&(B=E.subarray(18,E.length),lastStatKiller=Utf8ArrayToStr(B));break;case 2:lastStatKiller="the wall";break;case 3:lastStatKiller="yourself"}lsSet("lastTeamShareUrl",""),lsSet("lastTeamIp",""),allowSkipDeathTransition=closedBecauseOfDeath=!0,hideBanners(),refreshBanner(),document.getElementById("newsbox").style.display=null,deathTransitionTimeout=window.setTimeout(function(){skipDeathTransition?doTransition("",!1,function(){window.setTimeout(afterDeath,700),onClose(),resetAll()}):doTransition("GAME OVER",!0,null,function(){window.setTimeout(afterDeath,250),onClose(),resetAll()},!0),deathTransitionTimeout=null},1e3)}if(E[0]==receiveAction.MINIMAP){var H,F=20*E[1];for(minimapCtx.clearRect(2*F,0,40,160),minimapCtx.fillStyle="#000000",k=1;k<E.length;k++)for(o=0;o<8;o++){0!=(E[k]&1<<o)&&(H=8*(k-2)+o,u=Math.floor(H/80)%80+F,t=H%80,minimapCtx.fillRect(2*u,2*t,2,2))}}E[0]==receiveAction.PLAYER_SKIN&&((g=getPlayer(h=bytesToInt(E[1],E[2]))).isMyPlayer&&(myColorId=E[3],colorUI()),g.skinBlock=E[3]),E[0]==receiveAction.READY&&(playingAndReady=!0,isTransitioning||(isTransitioning=!0,onConnectOrMiddleOfTransition())),E[0]==receiveAction.PLAYER_HIT_LINE&&(g=getPlayer(h=bytesToInt(E[1],E[2])),v=getColorForBlockSkinId(E[3]),u=bytesToInt(E[4],E[5]),t=bytesToInt(E[6],E[7]),S=!1,8<E.length&&(S=1==E[8]),g.addHitLine([u,t],v,S),g.isMyPlayer&&!S&&doCamShakeDir(g.dir,10,!1)),E[0]==receiveAction.REFRESH_AFTER_DIE&&(doRefreshAfterDie=!0),E[0]==receiveAction.PLAYER_HONK&&(g=getPlayer(h=bytesToInt(E[1],E[2])),C=E[3],g.doHonk(C)),E[0]==receiveAction.PONG&&(P=Date.now()-lastPingTime,x=Math.abs(P-thisServerLastPing),thisServerDiffPing=lerp(x,thisServerDiffPing=Math.max(thisServerDiffPing,x),.5),thisServerAvgPing=lerp(thisServerAvgPing,P,.5),thisServerLastPing=P,lastPingTime=Date.now(),waitingForPing=!1),E[0]==receiveAction.UNDO_PLAYER_DIE&&(g=getPlayer(h=bytesToInt(E[1],E[2]))).undoDie(),E[0]==receiveAction.TEAM_LIFE_COUNT&&setLives(E[1],E[2])}function wsSendMsg(t,n){var e;if(ws&&ws.readyState==WebSocket.OPEN){var a,i,o,s=[t];if(t==sendAction.UPDATE_DIR&&(s.push(n.dir),a=intToBytes(n.coord[0],2),s.push(a[0]),s.push(a[1]),i=intToBytes(n.coord[1],2),s.push(i[0]),s.push(i[1])),t!=sendAction.SET_USERNAME&&t!=sendAction.SET_TEAM_USERNAME&&t!=sendAction.PATREON_CODE||(e=toUTF8Array(n),s.push.apply(s,e)),t==sendAction.SKIN&&(s.push(n.blockColor),s.push(n.pattern)),t==sendAction.REQUEST_CLOSE)for(var r=0;r<n.length;r++)s.push(n[r]);t==sendAction.HONK&&s.push(n),t==sendAction.MY_TEAM_URL&&(e=toUTF8Array(n),s.push.apply(s,e)),t==sendAction.VERSION&&(s.push(n.type),o=intToBytes(n.ver,2),s.push(o[0]),s.push(o[1]));var l=new Uint8Array(s);try{return ws.send(l),!0}catch(e){console.log("error sending message",t,n,s,e)}}return!1}function resetAll(){ws&&ws.readyState==WebSocket.OPEN&&ws.close(),isConnecting=!1,blocks=[],myPos=ws=null,scoreStat=scoreStatTarget=realScoreStat=realScoreStatTarget=25,totalPlayers=myRank=0,titleComplete=!(camShakeForces=[]),skipDeathTransition=allowSkipDeathTransition=!(resetTitleNextFrame=!(playingAndReady=myRankSent=!(beginScreenVisible=!(camPosSet=!(players=[]))))),minimapCtx.clearRect(0,0,160,160),didSendSecondReady=hasReceivedChunkThisGame=!1,showBeginHideMainCanvas(),doRefreshAfterDie&&location.reload();var e=document.body.style;e.webkitFilter=e.filter=null;for(var t=currentTopNotifications.length-1;0<=t;t--){currentTopNotifications[t].destroy()}currentTopNotifications=[],sendDirQueue=[],clearAllLives()}function initTutorial(){tutorialBlocks=[];for(var e=0;e<10;e++)for(var t=0;t<10;t++){var n=1<=e&&e<=3&&1<=t&&t<=3?10:1;getBlock(e,t,tutorialBlocks).setBlockId(n,!1)}var a=getPlayer(1,tutorialPlayers=[]);a.skinBlock=8,a.hasReceivedPosition=!0;var i=getPlayer(2,tutorialPlayers);i.skinBlock=0,i.pos=[-2,7],i.hasReceivedPosition=!0}function initSkinScreen(){skinButtonCanvas=document.getElementById("skinButton"),skinButtonShadow=document.getElementById("skinButtonShadow"),shareTw=document.getElementById("shareTw"),shareFb=document.getElementById("shareFb"),shareTw.onclick=function(){popUp("https://twitter.com/intent/tweet?text=Check%20out%20this%20game%20I%27ve%20just%20found&amp;url=http://splix.io&amp;hashtags=splixio&amp;related=splixio%3AOfficial%20Twitter%20account,jespertheend%3ADeveloper,",500,300),share()},shareFb.onclick=function(){popUp("https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.facebook.com%2Fsplix.io%2F&display=popup&ref=plugin&src=like&app_id=840486436000126",500,300),share()},shareToUnlock=document.getElementById("shareToUnlock"),skinButtonCtx=skinButtonCanvas.getContext("2d"),skinButtonCanvas.onclick=function(){ws||isTransitioning||playingAndReady||doTransition("",!1,openSkinScreen)};var e=localStorage.getItem("skinColor");null===e&&(e=0),e=parseInt(e);var t=localStorage.getItem("skinPattern");null===t&&(t=0),t=parseInt(t),fillArea(0,0,2*VIEWPORT_RADIUS,2*VIEWPORT_RADIUS,e+1,t,skinScreenBlocks=[]),document.getElementById("prevColor").onclick=function(){skinButton(-1,0)},document.getElementById("nextColor").onclick=function(){skinButton(1,0)},document.getElementById("prevPattern").onclick=function(){skinButton(-1,1)},document.getElementById("nextPattern").onclick=function(){skinButton(1,1)},document.getElementById("skinSave").onclick=function(){doTransition("",!1,showBeginHideSkin)},getBlock(0,0,skinButtonBlocks).setBlockId(e+1,!1),skinButtonCanvas.onmouseover=function(){var e=localStorage.getItem("skinColor");null===e&&(e=0),0<(e=parseInt(e))&&skinButtonBlocks[0].setBlockId(e+1+SKIN_BLOCK_COUNT,!1)},skinButtonCanvas.onmouseout=function(){var e=localStorage.getItem("skinColor");null===e&&(e=0),skinButtonBlocks[0].setBlockId(parseInt(e)+1,!1)},checkShared()}function initTitle(){for(var e=0;e<titleLines.length;e++)for(var t=titleLines[e],n=0;n<t.line.length;n++)for(var a=t.line[n],i=0;i<a.length;i+=2)a[i]+=t.posOffset[0]-40,a[i+1]+=t.posOffset[1]-20;titCanvas=document.getElementById("logoCanvas"),titCtx=titCanvas.getContext("2d")}var selectedGamemode="Normal";function initGameModeUI(){(gamemodeDropDownEl=document.getElementById("gamemodeSelect")).value="Normal",gamemodeDropDownEl.onchange=function(){selectedGamemode=gamemodeDropDownEl.options[gamemodeDropDownEl.selectedIndex].value,setJoinButton();var e="Teams"==selectedGamemode;teamBox.style.display=e?null:"none",(e?teamDoConnect:changeTeamModeToNormalMode)()},initTeamUI()}function setJoinButton(){var e;joinButton.disabled=!1,joinButton.title="","Normal"==selectedGamemode?joinButton.value="Join":"Teams"==selectedGamemode&&(joinButton.value="Start",testTeamWsConnection()?(teamBeginUIIsHost||(joinButton.disabled=!0,joinButton.title="Only the team host can start a game"),teamPlayersList.childNodes.length<=1&&(joinButton.disabled=!0,joinButton.title="Not enough players")):(joinButton.disabled=!0,joinButton.title="Not connected to the team server"),e=1<teamPlayersList.childNodes.length,document.getElementById("teamShareLinkDesc").innerHTML=e?teamBeginUIIsHost?"Click Start to start the game.":"Waiting for host to start the game.":"Share this url with your<br>friends to create a team.",document.getElementById("teamPlayersContainer").style.display=e?null:"none")}var teamBeginUIIsHost=!1,teamWs4=null,teamWs6=null,teamWs=null,teamWs4Failed=!1,teamWs6Failed=!1,teamWsCloseWasIntended=!1,teamWsWasConnected=!1,teamShareUrl="",teamServers=[],activeTeamServers=[];function initTeamUI(){var e;teamShareLink.ondblclick=function(){window.getSelection&&selectTeamShareLink()},document.addEventListener("mouseup",function(){var e,t,n=window.getSelection();0<n.rangeCount&&((e=n.getRangeAt(0)).startContainer.parentElement==teamShareLink&&0===e.startOffset&&(n.removeAllRanges(),(t=document.createRange()).selectNodeContents(teamShareLink),t.setEnd(e.endContainer,e.endOffset),n.addRange(t)))}),teamShareCopyBtn.onclick=function(){var e=selectTeamShareLink();document.execCommand("copy"),e.removeAllRanges()},0!==location.hash.indexOf("#team-")||didConfirmOpenInApp||(teamShareUrl=location.hash.substring(6),(e=testExistingTeamHash())&&(preventTeamServerConnection=!0),gamemodeDropDownEl.value="Teams",gamemodeDropDownEl.onchange(),e&&connectWithTransition(!0)),nameInput.addEventListener("change",nameInputOnChange),teamNameInput.addEventListener("change",teamNameInputOnChange)}function testExistingTeamHash(){var e=Date.now()-parseInt(localStorage.lastTeamJoinTime),t=localStorage.lastTeamShareUrl,n=location.hash.substring(6);return e<36e5&&t==n}function selectTeamShareLink(){var e=document.createRange();e.selectNodeContents(teamShareLink);var t=window.getSelection();return t.removeAllRanges(),t.addRange(e),t}var teamDoConnectAfterServersGet=!1,connectedTeamServerLetter="";function teamDoConnect(){if(preventTeamServerConnection)preventTeamServerConnection=!1;else if(setTeamBoxLoadVisibility(),teamServers.length<=0)teamDoConnectAfterServersGet=!0;else{var e=null;if(0===location.hash.indexOf("#team-"))for(var t=location.hash.substr(6,1),n=0;n<teamServers.length;n++){var a=teamServers[n];a.letter==t&&(e=a)}null===e&&(e=randFromArray(activeTeamServers));IS_SECURE?e.securePort:e.port;connectedTeamServerLetter=e.letter,teamWs4=newTeamWs(e.ipv4+"/teams"),teamWs6=newTeamWs(e.ipv6+"/teams")}}function newTeamWs(e){var t=new WebSocket(SECURE_WS+e);return t.binaryType="arraybuffer",t.onmessage=function(e){teamWs==this&&teamWsOnMessage(e)},t.onclose=function(){teamWs4==this&&(teamWs4Failed=!0),teamWs6==this&&(teamWs6Failed=!0),(teamWs==this||teamWs4Failed&&teamWs6Failed)&&teamWsOnClose()},t.onopen=function(){testTeamWsConnection()?t.close():(teamWs=t,teamWs6=teamWs4=null,teamWsOnConnect()),setTeamBoxLoadVisibility()},t}function testTeamWsConnection(){return null!==teamWs&&teamWs.readyState==WebSocket.OPEN}function setTeamBoxLoadVisibility(){var e=testTeamWsConnection();teamBoxLoading.style.display=e?"none":null,teamBoxLoaded.style.display=e?null:"none"}function teamWsOnConnect(){var e,t;teamWsWasConnected=!(teamBeginUIIsHost=!1),setJoinButton(),setTeamNameUI(),0===location.hash.indexOf("#team-")?(t=(e=location.hash).substring(7,e.length),teamWsSendMsg(teamSendAction.REQUEST_TEAM_ID,t)):""!==lastTeamLostConnShareUrl&&Date.now()-lastTeamLostConnTime<12e4?(teamWsSendMsg(teamSendAction.REQUEST_TEAM_ID,lastTeamLostConnShareUrl.substring(1)),lastTeamLostConnShareUrl=""):teamWsSendMsg(teamSendAction.REQUEST_TEAM_ID),teamSendPlayerName(),teamSendTeamName(),teamSendPingData(),setNotification("")}var lastTeamLostConnShareUrl="",lastTeamLostConnTime=0;function teamWsOnClose(){teamWsCloseWasIntended||(teamWsWasConnected?(setNotification("The connection to the team server was lost :/"),lastTeamLostConnShareUrl=teamShareUrl,lastTeamLostConnTime=Date.now()):setNotification("Couldn't connect to the team server :/")),setTeamBoxLoadVisibility(),changeTeamModeToNormalMode(),teamWs6Failed=teamWs4Failed=teamWsCloseWasIntended=teamWsWasConnected=!1,teamPlayersList.innerHTML="",teamShareLink.innerHTML="loading..."}function teamWsClose(){teamWsCloseWasIntended=!0,testTeamWsConnection()&&teamWs.close(),teamWs=null,teamWsOnClose()}var skipChangeToNormalOnce=!1;function changeTeamModeToNormalMode(){skipChangeToNormalOnce?skipChangeToNormalOnce=!1:(0===location.hash.indexOf("#team")&&removeHash(),"Teams"==gamemodeDropDownEl.value&&(gamemodeDropDownEl.value="Normal",gamemodeDropDownEl.onchange()),skipChangeToNormalOnce=!0,teamWsClose())}function removeHash(){history.pushState("",document.title,location.pathname+location.search)}function testHashForMobile(){var e,t;deviceType==DeviceTypes.DESKTOP||""!=(e=location.hash)&&"#pledged"!=e&&(t="Would you like to open the splix.io app?",t=0===e.indexOf("#team")?"Would you like to join this team in the app?":"Would you like to join this server in the app?",confirm(t)&&(didConfirmOpenInApp=!0,openSplixApp(e.substring(1,e.length))))}function openSplixApp(e){var t=location.href="splix://"+e;deviceType==DeviceTypes.ANDROID&&-1<navigator.userAgent.toLowerCase().indexOf("chrome")&&(window.document.body.innerHTML="Chrome doesn't like auto redirecting, click <a href=\""+t+'">here</a> to open the splix.io app.')}function teamWsOnMessage(e){var t,n,a,i,o,s,r,l=new Uint8Array(e.data);if(l[0]==teamReceiveAction.URL&&(n=l.subarray(1,l.length),teamShareUrl=connectedTeamServerLetter+Utf8ArrayToStr(n),a=location.host+location.pathname+"#team-"+teamShareUrl,teamShareLink.innerHTML='<span class="teamShareLinkHidden">http://</span>'+a,location.hash="team-"+teamShareUrl),l[0]==teamReceiveAction.BECOME_HOST&&(teamBeginUIIsHost=!0,setJoinButton(),setTeamNameUI()),l[0]==teamReceiveAction.ADD_PLAYER&&(t=bytesToInt(l[1]),i=Utf8ArrayToStr(l.subarray(2,l.length)),o="teamPlayer-"+t,null===(s=document.getElementById(o))&&((s=document.createElement("li")).id=o,teamPlayersList.appendChild(s)),s.innerHTML=testEmtpyName(filter(htmlEscape(i))),setJoinButton()),l[0]==teamReceiveAction.REMOVE_PLAYER&&(o="teamPlayer-"+(t=bytesToInt(l[1])),null!==(s=document.getElementById(o))&&teamPlayersList.removeChild(s)),l[0]==teamReceiveAction.REQUEST_IPS){0==(d=l[1])&&(d=-1);var c=getServer(d,!1),d=c.locId;if(null===c)return void setNotification("Couldn't find a server to connect to :/");if(void 0===c.ip4||void 0===c.ip6){if(void 0===c.ip)return void setNotification("Couldn't find a server to connect to :/");teamWsSendMsg(teamSendAction.SEND_IPS,[d,c.ip,c.ip])}teamWsSendMsg(teamSendAction.SEND_IPS,[d,c.ip4,c.ip6])}if(l[0]==teamReceiveAction.GAME_START){d=l[1];for(var m=bytesToInt(l[2],l[3]),u=Utf8ArrayToStr(l.subarray(4,m+4)),p=Utf8ArrayToStr(l.subarray(m+4,l.length)),h="",g=0;g<servers.length;g++){var f=servers[g];if(f.locId==d){var T=!1;(0<f.pingTries6&&f.pingTries<=0||0<f.pingTries6&&0<f.pingTries&&f.avgPing6<f.avgPing)&&(T=!0),h=T?p:u;break}}lsSet("lastTeamShareUrl",teamShareUrl),lsSet("lastTeamIp",h),lsSet("lastTeamJoinTime",Date.now()),connectWithTransition(!0)}l[0]==teamReceiveAction.TEAM_IS_FULL&&(setNotification("This team is full :("),teamWsClose()),l[0]==teamReceiveAction.SET_TEAM_USERNAME&&(r=filter(r=Utf8ArrayToStr(l.subarray(1,l.length))),teamNameH.innerHTML=htmlEscape(r),teamBeginUIIsHost||(teamNameInput.value=r))}function teamWsSendMsg(t,n){var e;if(testTeamWsConnection()){var a,i,o,s=[t];if(t==teamSendAction.REQUEST_TEAM_ID&&n&&(e=toUTF8Array(n),s.push.apply(s,e)),t!=teamSendAction.MY_USERNAME&&t!=teamSendAction.SET_TEAM_USERNAME||n&&(e=toUTF8Array(n),s.push.apply(s,e)),t==teamSendAction.PING_DATA)for(var r=0;r<n.length;r++){var l=servers[r];s.push(l.locId);var c=0<l.pingTries?l.avgPing:0,d=0<l.pingTries6?l.avgPing6:0,c=Math.round(Math.min(Math.max(0,c),65e3)),d=Math.round(Math.min(Math.max(0,d),65e3)),m=intToBytes(c,2),u=intToBytes(d,2);s.push(m[0]),s.push(m[1]),s.push(u[0]),s.push(u[1])}t==teamSendAction.SEND_IPS&&(a=toUTF8Array(n[1]),i=toUTF8Array(n[2]),o=intToBytes(a.length,2),s.push(n[0]),s.push(o[0]),s.push(o[1]),s.push.apply(s,a),s.push.apply(s,i));var p=new Uint8Array(s);try{return teamWs.send(p),!0}catch(e){console.log("error sending team message",t,n,s,e)}}return!1}function teamSendPlayerName(){teamWsSendMsg(teamSendAction.MY_USERNAME,nameInput.value)}function teamSendTeamName(){teamWsSendMsg(teamSendAction.SET_TEAM_USERNAME,teamNameInput.value)}function teamSendPingData(){teamWsSendMsg(teamSendAction.PING_DATA,servers)}function testEmtpyName(e){return/\S/.test(e)?e:"Enter your name..."}function setTeamNameUI(){teamBeginUIIsHost?(teamNameH.style.display="none",teamNameInput.style.display=null):(teamNameH.style.display=null,teamNameInput.style.display="none")}function teamNameInputOnChange(){teamSendTeamName(),lsSet("teamName",teamNameInput.value)}var canRunAdsRequested=!1;function requestCanRunAds(){!canRunAdsRequested&&testPatreonAdsAllowed()&&fetch("https://api.adinplay.com/libs/aiptag/pub/JTE/splix.io/tag.min.js",{mode:"no-cors"}).then(function(){canRunAdsRequested=canRunAds=!0},function(){canRunAdsRequested=!0})}var initVidAdsCalled=!1;function initVideoAdsScript(){var e,t;!initVidAdsCalled&&testPatreonAdsAllowed()&&(initVidAdsCalled=!0,e=document.getElementsByTagName("head")[0],bannerAdsUseCurse?((t=document.createElement("script")).type="text/javascript",t.src="//api.adinplay.com/player/v2/JTE/splix.io/player.min.js",e.appendChild(t)):aiptag.cmd.player.push(function(){adplayer=new aipPlayer({AD_WIDTH:960,AD_HEIGHT:540,AD_FULLSCREEN:!1,AD_CENTERPLAYER:!1,LOADING_TEXT:"loading advertisement",PREROLL_ELEM:function(){return prerollElem},AIP_COMPLETE:function(e){console.log("Ad: "+e+" Completed"),onAdFinish()},AIP_REMOVE:function(){}})}))}var prerollElem,isWaitingForAd=!1,boltIsRendered=!1;function displayAd(){isWaitingForAd=!0,formElem.style.display="none",prerollElem.style.display=null,bannerAdsUseCurse?"undefined"!=typeof aipPlayer?(adplayer=new aipPlayer({AD_WIDTH:960,AD_HEIGHT:540,PREROLL_ELEM:prerollElem,AIP_COMPLETE:function(){onAdFinish()}}),adplayer.startPreRoll(),onAdLoaded()):(console.log("couldn't load ad, aipPlayer not defined"),onAdFinish()):(aiptag.cmd.player.push(function(){adplayer.startPreRoll()}),onAdLoaded()),scrollAd()}function getScript(e,t){var n=document.head||document.getElementsByTagName("head")[0],a=document.createElement("script"),i=!0;a.async="async",a.type="text/javascript",a.charset="UTF-8",a.src=e,a.onload=a.onreadystatechange=function(){!i||a.readyState&&!/loaded|complete/.test(a.readyState)||(i=!1,t(),a.onload=a.onreadystatechange=null)},n.appendChild(a)}var prerollIsVisible=!1;function onAdLoaded(e){lsSet("refreshDuringAd","true"),prerollIsVisible=!0,document.getElementById("shareText").className=shareToUnlock.className=appLinksElem.className="adRunning",hideBanners(),destroyBanners()}function scrollAd(){var e=prerollElem.offsetTop,t=e+prerollElem.offsetHeight,n=document.documentElement.scrollTop||document.body.scrollTop,a=n+window.innerHeight,i=(e+t)/2;(e<n||a<t)&&window.scroll(0,i-window.innerHeight/2)}function onAdFinish(){countAd(),lsSet("refreshDuringAd",""),prerollIsVisible=!1,lsSet("lastAdTime",Date.now()),formElem.style.display=null,prerollElem.style.display="none",document.getElementById("shareText").className=shareToUnlock.className=null,connectWithTransition(!(isWaitingForAd=isConnectingWithTransition=!1))}function getAdCounter(){var e=localStorage.adCounter;return void 0===e&&(e=0),e=parseInt(e),isNaN(e)&&(e=0),e}function countAd(){var e=getAdCounter();5<++e&&(e=0),lsSet("adCounter",e)}function refreshBanner(){testPatreonAdsAllowed()&&(bannerAdsUseCurse?(setUpAdBoxContent(),"undefined"!=typeof factorem&&setTimeout(factorem.refreshAds.bind(factorem,null,!0),10)):aiptag.cmd.display.push(function(){aipDisplayTag.display("JTE_splix-io_300x250")}))}function showBanner(){prerollIsVisible||(adBox.style.visibility=null)}function showBanner2(){prerollIsVisible||(adBox2.style.visibility=null)}function destroyBanners(){bannerAdsUseCurse&&(adBox.innerHTML="",adBox2.innerHTML="")}function hideBanners(){adBox.style.visibility=adBox2.style.visibility="hidden"}function setAdBoxLeft(){adBox.style.left="-"+(adBox.clientWidth+20)+"px"}function setUpAdBoxContent(){destroyBanners(),adBoxContentDiv=document.createElement("div"),adBoxContentDiv2=document.createElement("div"),bannerAdsUseCurse?(adBoxContentDiv.id="cdm-zone-02",adBoxContentDiv2.id="cdm-zone-01"):adBoxContentDiv.id="JTE_splix-io_300x250",adBox.appendChild(adBoxContentDiv),adBox2.appendChild(adBoxContentDiv2)}function onAdBoxLoaded(){showBanner(),setAdBoxLeft()}function onAdBox2Loaded(){showBanner2()}var adBoxContentDiv=null,prevAdboxContentWidth=0,prevAdboxContentHeight=0,adBox=null;function testAdBoxLoaded(){adBoxContentDiv&&(prevAdboxContentWidth==adBoxContentDiv.clientWidth&&prevAdboxContentHeight==adBoxContentDiv.clientHeight||(prevAdboxContentWidth=adBoxContentDiv.clientWidth,prevAdboxContentHeight=adBoxContentDiv.clientHeight,onAdBoxLoaded()))}var adBoxContentDiv2=null,prevAdbox2ContentWidth=0,prevAdbox2ContentHeight=0,adBox2=null;function testAdBox2Loaded(){adBoxContentDiv2&&(prevAdbox2ContentWidth==adBoxContentDiv2.clientWidth&&prevAdbox2ContentHeight==adBoxContentDiv2.clientHeight||(prevAdbox2ContentWidth=adBoxContentDiv2.clientWidth,prevAdbox2ContentHeight=adBoxContentDiv2.clientHeight,onAdBox2Loaded()))}function setCookieNoticeVisibility(){var e=null===localStorage.getItem("hasAdsConsent")&&!bannerAdsUseCurse;document.getElementById("euConsent").style.display=e?null:"none"}function showCursor(){document.body.style.cursor=null}setCookieNoticeVisibility(),document.getElementById("euConsentAgreeBtn").addEventListener("click",function(){lsSet("hasAdsConsent","true"),aiptag.consented=!0,refreshBanner(),setCookieNoticeVisibility()}),document.getElementById("euConsentDeny").addEventListener("click",function(){lsSet("hasAdsConsent","false"),aiptag.consented=!1,setCookieNoticeVisibility()});var afterDeathCounter=0;function afterDeath(){switch(++afterDeathCounter){case 1:window.twttr=(T=document,y="twitter-wjs",S=T.getElementsByTagName("script")[0],C=window.twttr||{},T.getElementById(y)||((v=T.createElement("script")).id=y,v.src="https://platform.twitter.com/widgets.js",S.parentNode.insertBefore(v,S),C._e=[],C.ready=function(e){C._e.push(e)}),C),twttr.ready(function(e){e.events.bind("rendered",function(){twttrIsInit=!0,testSocialReady()}),e.events.bind("tweet",function(){share()})}),window.fbAsyncInit=function(){FB.Event.subscribe("xfbml.render",function(){fbIsInit=!0,testSocialReady()}),FB.init({appId:"1812921762327343",autoLogAppEvents:!0,xfbml:!0,version:"v3.1"})},p=document,h="facebook-jssdk",f=p.getElementsByTagName("script")[0],p.getElementById(h)||((g=p.createElement("script")).id=h,g.src="https://connect.facebook.net/en_US/sdk.js",f.parentNode.insertBefore(g,f));var e=document.getElementsByTagName("head")[0],t=document.createElement("script");t.type="text/javascript",t.src="https://apis.google.com/js/platform.js",t.onload=function(){ytIsInit=!0},e.appendChild(t);var n=document.createElement("img");n.id="discord",n.className="socialHover",n.draggable=!1,n.title="splix.io discord group",n.onload=function(){discordIsInit=!0,testSocialReady()},n.src="/img/discord.svg",document.getElementById("discordA").appendChild(n);var a=document.createElement("img");a.id="reddit",a.className="socialHover",a.draggable=!1,a.title="splix.io on reddit",a.onload=function(){redditIsInit=!0,testSocialReady()},a.src="/img/reddit.svg",document.getElementById("redditA").appendChild(a);var i=document.createElement("img");i.id="patreonCornerButton",i.className="socialHover",i.draggable=!1,i.title="Become a patreon of splix.io",i.onload=function(){patreonCornerButtonIsInit=!0,testSocialReady()},i.src="/img/patreon.png";var o=document.getElementById("patreonA");o.appendChild(i),o.appendChild(document.createElement("br"));var s=document.createElement("img");s.alt="Get it on Google Play",s.style.width="250px",s.style.display="block",s.onload=function(){androidImgIsInit=!0,testAppLinksReady()},s.src="https://play.google.com/intl/en_us/badges/images/generic/en_badge_web_generic.png";var r=document.createElement("a");r.href="https://play.google.com/store/apps/details?id=com.Jespertheend.splix",r.target="_blank",r.appendChild(s),appLinksElem.appendChild(r);var l=document.createElement("img");l.alt="Download on the App Store",l.style.width="220px",l.style.marginBottom="15px",l.onload=function(){appleImgIsInit=!0,testAppLinksReady()},l.src="https://linkmaker.itunes.apple.com/images/badges/en-us/badge_appstore-lrg.svg";var c=document.createElement("a");c.href="https://itunes.apple.com/app/id1150901618",c.target="_blank",c.appendChild(l),appLinksElem.appendChild(c);var d="splixio.org;splix-io.net;splixio.net;splixio.org".split(";");if(this.top.location!==this.location)for(var m=0;m<d.length;m++){var u=d[m];-1!=document.referrer.indexOf(u)&&(this.top.location=this.location)}requestCanRunAds(),initVideoAdsScript()}var p,h,g,f,T,y,v,S,C}var doneAppLinksReady=!1,animateAppLinks=!1,appLinksTimer=-3,androidImgIsInit=!1,appleImgIsInit=!1;function testAppLinksReady(){androidImgIsInit&&appleImgIsInit&&!doneAppLinksReady&&(doneAppLinksReady=!0,onAppLinksReady())}function onAppLinksReady(){animateAppLinks=!0}var doneOnSocialReady=!1,twttrIsInit=!1,fbIsInit=!1,ytIsInit=!1,discordIsInit=!1,redditIsInit=!1,patreonCornerButtonIsInit=!1;function testSocialReady(){twttrIsInit&&fbIsInit&&ytIsInit&&discordIsInit&&redditIsInit&&patreonCornerButtonIsInit&&!doneOnSocialReady&&(doneOnSocialReady=!0,onSocialReady())}function onSocialReady(){socialIsReady=!0,socialElem.style.display=null,window.setTimeout(function(){testSocialTarget()},500)}function testSocialTarget(){socialOTarget=socialIsReady?socialHovering?1:.2:0}function popUp(e,t,n){var a=screen.width/2-t/2,i=screen.height/2-n/2;window.open(e,"_blank","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+t+", height="+n+", top="+i+", left="+a)}function share(e){void 0===e&&(e=3e3),lsSet("s",1),window.setTimeout(function(){checkShared()},e)}function checkShared(){var e=!!localStorage.s,t=e?null:"none",n=e?"none":null;skinButtonCanvas.style.display=t,skinButtonShadow.style.display=t,shareToUnlock.style.display=n}function colorUI(){for(var e=getColorForBlockSkinId(myColorId),t=e.brighter,n=e.darker,a=0;a<uiElems.length;a++){colorBox(uiElems[a],t,n)}}function colorBox(e,t,n){e.style.backgroundColor=t,e.style.boxShadow="1px 1px "+n+",2px 2px "+n+",3px 3px "+n+",4px 4px "+n+",5px 5px "+n+",10px 30px 80px rgba(0,0,0,0.3)"}function skinButton(e,t){if(0===t){var n=localStorage.getItem("skinColor"),a=[];300<=localStorage.patreonLastPledgedValue||a.push(13),null===n&&(n=0),n=parseInt(n);for(var i=!1;!i;)n=mod(n+=e,SKIN_BLOCK_COUNT+1),a.indexOf(n)<0&&(i=!0);lsSet("skinColor",n)}else if(1==t){var o=localStorage.getItem("skinPattern"),s=[18,19,20,21,23,24,25,26];0<localStorage.patreonLastPledgedValue||s.push(27),null===o&&(o=0),o=parseInt(o);for(var r=!1;!r;)o=mod(o+=e,SKIN_PATTERN_COUNT),s.indexOf(o)<0&&(r=!0);lsSet("skinPattern",o)}updateSkin()}function updateSkin(){var e=parseInt(localStorage.skinColor)+1;fillArea(0,0,2*VIEWPORT_RADIUS,2*VIEWPORT_RADIUS,e,parseInt(localStorage.skinPattern),skinScreenBlocks),skinButtonBlocks[0].setBlockId(e)}var lifeBox,lives=[];function clearAllLives(){lifeBox.innerHTML="",lives=[]}function setLives(e,t){for(var n=lives.length,a=0;a<t-n;a++){var i=document.createElement("canvas");i.style.margin="-15px";var o=i.getContext("2d"),s={node:i,ctx:o,timer:0,animDir:0,isLife:!0,render:function(e,t){var n,a;0===this.animDir&&!t||(this.timer+=e*this.animDir*.002,1==this.animDir?1<this.timer&&(this.timer=1,this.afterAnimate()):this.timer<0&&(this.timer=0,this.afterAnimate()),canvasTransformType=canvasTransformTypes.LIFE,ctxApplyCamTransform(this.ctx,!0,!0),this.ctx.fillStyle="rgba(0,0,0,0.3)",this.drawHeart(!1,15.7,15.7),1==this.animDir?(this.ctx.fillStyle=colors.red.darker,this.ctx.translate(30,30),a=.5*(1-(n=(n=this.timer)<.8?lerp(0,1.2,ease.in(iLerp(0,.8,n))):lerp(1.2,1,ease.in(iLerp(.8,1,n))))),this.ctx.rotate(a),this.ctx.scale(n,n),this.ctx.translate(-30,-30),this.drawHeart(!1,15.7,15.7),this.ctx.fillStyle=colors.red.brighter,this.drawHeart(!1,14.3,14.3)):(this.ctx.globalAlpha=this.timer,this.ctx.fillStyle=colors.red.darker,this.drawHeart(!0,15.7,15.7),this.ctx.fillStyle=colors.red.brighter,this.drawHeart(!0,14.3,14.3)),this.ctx.restore())},drawHeart:function(e,t,n){var a,i,o;e&&1!=this.timer?(i=t+3*(a=ease.out(1-this.timer)),o=n-12*a,this.ctx.beginPath(),this.ctx.moveTo(15+i,16.5+o),this.ctx.lineTo(15+i,12+o),this.ctx.bezierCurveTo(15+i,8.1+o,17.4+i,5.25+o,21+i,5.25+o),this.ctx.fill(),i=t+9*a,o=n-1.5*a,this.ctx.beginPath(),this.ctx.moveTo(15+i,16.5+o),this.ctx.lineTo(21+i,5.25+o),this.ctx.bezierCurveTo(24+i,5.25+o,27+i,7.5+o,27+i,12+o),this.ctx.bezierCurveTo(27+i,15.3+o,23.25+i,19.35+o,23.1+i,19.5+o),this.ctx.fill(),i=t+6*a,o=n+9*a,this.ctx.beginPath(),this.ctx.moveTo(15+i,16.5+o),this.ctx.lineTo(23.1+i,19.5+o),this.ctx.bezierCurveTo(23.1+i,19.8+o,17.55+i,25.11+o,17.1+i,25.35+o),this.ctx.fill(),i=t-1.5*a,o=n+9*a,this.ctx.beginPath(),this.ctx.moveTo(15+i,16.5+o),this.ctx.lineTo(17.1+i,25.35+o),this.ctx.lineTo(15+i,27+o),this.ctx.bezierCurveTo(14.91+i,27+o,10.5+i,23.28+o,10.5+i,23.16+o),this.ctx.fill(),i=t-12*a,o=n+1.5*a,this.ctx.beginPath(),this.ctx.moveTo(15+i,16.5+o),this.ctx.lineTo(10.5+i,23.16+o),this.ctx.bezierCurveTo(10.5+i,23.16+o,3+i,16.65+o,3+i,12+o),this.ctx.fill(),i=t-3*a,o=n-6*a,this.ctx.beginPath(),this.ctx.moveTo(15+i,16.5+o),this.ctx.lineTo(3+i,12+o),this.ctx.bezierCurveTo(3+i,3+o,15+i,3+o,15+i,12+o)):(this.ctx.beginPath(),this.ctx.moveTo(15+t,12+n),this.ctx.bezierCurveTo(15+t,3+n,27+t,3+n,27+t,12+n),this.ctx.bezierCurveTo(27+t,18+n,15+t,27+n,15+t,27+n),this.ctx.bezierCurveTo(15+t,27+n,3+t,18+n,3+t,12+n),this.ctx.bezierCurveTo(3+t,3+n,15+t,3+n,15+t,12+n)),this.ctx.fill()},afterAnimate:function(){this.animDir=0,this.set(this.isLife)},set:function(e){this.isLife=e,0===this.animDir&&(e?this.timer<1&&(this.animDir=1):0<this.timer&&(this.animDir=-1))}};lifeBox.appendChild(i),lives.push(s),s.render(0,!0)}for(a=n-1;t<=a;a--)s=lives[a],lifeBox.removeChild(s.node),lives.splice(a,1);for(a=0;a<lives.length;a++)(s=lives[a]).set(a<e)}function renderAllLives(e){for(var t=0;t<lives.length;t++){lives[t].render(e)}}var engagementIsPlaying="true"==localStorage.engagementIsPlaying,engagementLastPlayTime=localStorage.engagementLastPlayTime;void 0===engagementLastPlayTime&&(engagementLastPlayTime=Date.now());var engagementLastNoPlayTime=0,engagementLastChangeTime=localStorage.engagementLastChangeTime;void 0===engagementLastChangeTime&&(engagementLastChangeTime=Date.now());var engagementValue=localStorage.engagementValue;function engagementSetIsPlaying(e){var t,n=Date.now();e!=engagementIsPlaying&&(lsSet("engagementIsPlaying",e),t=((engagementIsPlaying=e)?engagementLastNoPlayTime:engagementLastPlayTime)-engagementLastChangeTime,t/=2e4,lsSet("engagementValue",engagementValue=e?lerptt(engagementValue,0,.01,t/100):lerptt(engagementValue,1,.01,t)),lsSet("engagementLastChangeTime",engagementLastChangeTime=n)),e?(lsSet("engagementLastPlayTime",n),engagementLastPlayTime=n):engagementLastNoPlayTime=n}engagementValue=void 0===engagementValue?.5:parseFloat(engagementValue);var retentionSamples=[];function loopRetentionSamples(e){for(var t=0;t<retentionSamples.length;t++){var n,a=retentionSamples[t];a.secondsFromNow-=e/1e3,a.secondsFromNow<0&&(n=a.sampleId,-1==sentRetentionSamples.indexOf(n)&&(sentRetentionSamples.push(n),saveSentRetentionSamples(),simpleRequest("http://stats.splix.io/retention.php?value="+Math.round(100*engagementValue)+"&id="+n)))}}var sentRetentionSamples=[];function loadSentRetentionSamples(){var e=localStorage.sentRetentionSamples;void 0===e&&(e="");var t=e.split(",");sentRetentionSamples=[];for(var n=0;n<t.length;n++){var a=parseInt(t[n]);isNaN(a)||sentRetentionSamples.push(a)}}function saveSentRetentionSamples(){lsSet("sentRetentionSamples",sentRetentionSamples.join(","))}function loginWithPatreon(){lsSet("clickedLoginWithPatreonButton","true");var e=getPatreonRedirectUri();window.location="//www.patreon.com/oauth2/authorize?response_type=code&client_id=29edae8672a352342c2ecda5ff440eda65e5e52ebc7500b02eefb481c94c88b1&scope=users%20pledges-to-me%20my-campaign&redirect_uri="+encodeURIComponent(e)}function getPatreonRedirectUri(){return location.origin+location.pathname}function setPatreonOverlay(e,t){document.getElementById("patreonOverlay").style.display=e?null:"none",void 0!==t&&(document.getElementById("patreonBox").innerHTML=t)}function requestPatreonPledgeData(t){void 0===localStorage.patreonDeviceId||""==localStorage.patreonDeviceId?resetPatreonPledgedData():simpleRequest("https://patreon.splix.io/requestPledge2.php?deviceId="+localStorage.patreonDeviceId,function(e){"pledged"in(e=JSON.parse(e))&&"splixCode"in e?(lsSet("patreonLastPledgedValue",e.pledged),lsSet("patreonLastSplixCode",e.splixCode),t&&setPatreonOverlay(!0,'<h2 style="margin-top: 0;">All set!</h2><p>Successfully logged in with patreon.<br>Reload the page to activate your pledge.</p><a class="fancyBox fancyBtn" href="javascript:window.location.href = window.location.origin + window.location.pathname + \'#nohttpsredirect\'">Reload</a>')):resetPatreonPledgedData()})}function resetPatreonPledgedData(){lsSet("patreonLastPledgedValue",0),lsSet("patreonLastSplixCode","")}function testPatreonAdsAllowed(){return"true"!=localStorage.fuckAds&&!(0<localStorage.patreonLastPledgedValue)}function checkPatreonQuery(){var e=parseQuery(location.href),t=!1;return"code"in e&&"true"==localStorage.clickedLoginWithPatreonButton&&("true"==localStorage.skipPatreon?console.log("code: ",e.code):(deviceType!=DeviceTypes.DESKTOP&&confirm("Would you like to activate patreon in the app?")?openSplixApp("patreoncode-"+e.code):(setPatreonOverlay(!0,"Logging in with patreon..."),simpleRequest("https://patreon.splix.io/login2.php?code="+e.code+"&redirectUri="+encodeURIComponent(getPatreonRedirectUri()),function(e){lsSet("patreonDeviceId",e),requestPatreonPledgeData(!0)})),t=!0)),lsSet("clickedLoginWithPatreonButton","false"),t}function removeBlocksOutsideViewport(e){for(i=blocks.length-1;0<=i;i--){var t=blocks[i];(t.x<e[0]-2*VIEWPORT_RADIUS||t.x>e[0]+2*VIEWPORT_RADIUS||t.y<e[1]-2*VIEWPORT_RADIUS||t.y>e[1]+2*VIEWPORT_RADIUS)&&blocks.splice(i,1)}}function getColorForBlockSkinId(e){switch(e){case 0:return colors.red;case 1:return colors.red2;case 2:return colors.pink;case 3:return colors.pink2;case 4:return colors.purple;case 5:return colors.blue;case 6:return colors.blue2;case 7:return colors.green;case 8:return colors.green2;case 9:return colors.leaf;case 10:return colors.yellow;case 11:return colors.orange;case 12:return colors.gold;default:return{brighter:"#000000",darker:"#000000",slightlyBrighter:"#000000"}}}function ctxCanvasSize(e,t){var n=window.innerWidth,a=window.innerHeight;canvasTransformType==canvasTransformTypes.TUTORIAL&&(n=a=300),canvasTransformType==canvasTransformTypes.SKIN_BUTTON&&(n=a=30),canvasTransformType==canvasTransformTypes.LIFE&&(n=a=60),canvasTransformType==canvasTransformTypes.TITLE&&(n=520,a=180);var i=t?1:canvasQuality,o=e.canvas;o.width=n*MAX_PIXEL_RATIO*i,o.height=a*MAX_PIXEL_RATIO*i;var s=1;canvasTransformType==canvasTransformTypes.TITLE&&(s=Math.min(1,(window.innerWidth-30)/n)),o.style.width=n*s+"px",o.style.height=a*s+"px"}loadSentRetentionSamples();var canvasTransformTypes={MAIN:1,TUTORIAL:2,SKIN:3,SKIN_BUTTON:4,TITLE:5,LIFE:6},canvasTransformType=canvasTransformTypes.MAIN;function ctxApplyCamTransform(e,t,n){t&&ctxCanvasSize(e,n),e.save();var a,i,o,s,r=n?1:canvasQuality;canvasTransformType!=canvasTransformTypes.MAIN&&canvasTransformType!=canvasTransformTypes.SKIN&&e.setTransform(MAX_PIXEL_RATIO*r,0,0,MAX_PIXEL_RATIO*r,0,0),canvasTransformType==canvasTransformTypes.MAIN||canvasTransformType==canvasTransformTypes.SKIN?(a=canvasTransformType==canvasTransformTypes.MAIN,e.translate(mainCanvas.width/2,mainCanvas.height/2),i=Math.max(mainCanvas.width,mainCanvas.height)/MAX_ZOOM,o=mainCanvas.width*mainCanvas.height/BLOCKS_ON_SCREEN,s=Math.sqrt(o)/10,zoom=Math.max(s,i),a&&e.rotate(camRotOffset),e.scale(zoom,zoom),a?e.translate(10*-camPosPrevFrame[0]-camPosOffset[0],10*-camPosPrevFrame[1]-camPosOffset[1]):e.translate(10*-VIEWPORT_RADIUS,10*-VIEWPORT_RADIUS)):canvasTransformType!=canvasTransformTypes.TUTORIAL&&canvasTransformType!=canvasTransformTypes.SKIN_BUTTON||e.scale(3,3)}function doCamShake(e,t,n){void 0===n&&(n=!0),camShakeForces.push([e,t,0,!!n])}function doCamShakeDir(e,t,n){void 0===t&&(t=6);var a=0,i=0;switch(e){case 0:a=t;break;case 1:i=t;break;case 2:a=-t;break;case 3:i=-t}doCamShake(a,i,n)}function calcCamOffset(){camPosOffset=[0,0],camRotOffset=0;for(var e=camShakeForces.length-1;0<=e;e--){var t=camShakeForces[e];t[2]+=.003*deltaTime;var n=t[2],a=0,i=0;n<1?(i=ease.out(n),a=ease.inout(n)):n<8?(i=ease.inout(iLerp(8,1,n)),a=ease.in(iLerp(8,1,n))):camShakeForces.splice(e,1),camPosOffset[0]+=t[0]*i,camPosOffset[1]+=t[1]*i,camPosOffset[0]+=t[0]*Math.cos(8*n)*.04*a,camPosOffset[1]+=t[1]*Math.cos(7*n)*.04*a,t[3]&&(camRotOffset+=.003*Math.cos(9*n)*a)}camPosOffset[0]/=80,camPosOffset[1]/=80,camPosOffset[0]=smoothLimit(camPosOffset[0]),camPosOffset[1]=smoothLimit(camPosOffset[1]),camPosOffset[0]*=80,camPosOffset[1]*=80}function lerp(e,t,n){return e+n*(t-e)}function iLerp(e,t,n){return(n-e)/(t-e)}function lerpt(e,t,n){return lerptt(e,t,n,deltaTime/16.6666)}function lerptt(e,t,n,a){return lerp(e,t,1-Math.pow(1-n,a))}function lerpA(e,t,n){for(var a=[],i=0;i<e.length;i++)a.push(lerp(e[i],t[i],n));return a}function mod(e,t){return(e%t+t)%t}function clamp(e,t,n){return Math.max(t,Math.min(n,e))}function clamp01(e){return clamp(e,0,1)}function randFromArray(e){return e[Math.floor(Math.random()*e.length)]}function smoothLimit(e){var t=e<0;return t&&(e*=-1),e=1-Math.pow(2,-e),t&&(e*=-1),e}function updateStats(){totalPlayers<myRank&&myRankSent?totalPlayers=myRank:(totalPlayers<myRank||0===myRank&&0<totalPlayers)&&(myRank=totalPlayers),myRankElem.innerHTML=myRank,totalPlayersElem.innerHTML=totalPlayers}function drawTrailOnCtx(e,t,n){if(0<t.length)for(var a=0;a<e.length;a++){var i=e[a],o=i.ctx;o.lineCap="round",o.lineJoin="round",o.lineWidth=6,o.strokeStyle=i.color;var s=i.offset;o.beginPath(),o.moveTo(10*t[0][0]+s,10*t[0][1]+s);for(var r=1;r<t.length;r++)o.lineTo(10*t[r][0]+s,10*t[r][1]+s);null!==n&&o.lineTo(10*n[0]+s,10*n[1]+s),o.stroke()}}function drawDiagonalLines(e,t,n,a,i){if(0<n){e.lineCap="butt",e.strokeStyle=t,e.lineWidth=n;var o=20*VIEWPORT_RADIUS,s=0,r=0;null!==camPosPrevFrame&&canvasTransformType==canvasTransformTypes.MAIN&&(s=Math.round((10*camPosPrevFrame[0]-o/2)/a)*a,r=Math.round((10*camPosPrevFrame[1]-o/2)/a)*a),s+=i%a;for(var l=-o;l<o;l+=a){var c=s+l;e.beginPath(),e.moveTo(c,r),e.lineTo(c+o,r+o),e.stroke()}}}function drawAnimatedText(e,t,n,a,i,o,s,r,l,c,d){var m;void 0===s&&(s="white"),e.fillStyle=s,void 0===r&&(r="Arial, Helvetica, sans-serif"),e.font=r=o+"px "+r,void 0===d&&(d=0);for(var u=0,p=0;p<transitionText.length;p++){var h=rndSeed(p+d);void 0===c&&(c=3);var g=n*c-h*(c-h),f=transitionText[p],T=e.measureText(f).width,y=i-.77*o;if(g<.8)tempCanvas.width=T,tempCanvas.height=o,tempCtx.font=r,tempCtx.fillStyle="white",tempCtx.fillText(f,0,.77*o),g<.4?(m=g/.4,tempCtx.beginPath(),tempCtx.moveTo(0,lerp(o,0,m)),tempCtx.lineTo(0,o),tempCtx.lineTo(lerp(0,T,m),o),tempCtx.closePath()):(m=g/.4-1,tempCtx.moveTo(0,0),tempCtx.lineTo(0,o),tempCtx.lineTo(T,o),tempCtx.lineTo(T,lerp(o,0,m)),tempCtx.lineTo(lerp(0,T,m),0)),tempCtx.globalCompositeOperation="destination-in",tempCtx.fill(),e.drawImage(tempCanvas,a+u,y);else{var v=(m=Math.min(1,5*g-4))*l;e.fillStyle=colors.green2.darker;for(var S=0;S<v;S++)e.fillText(f,a+u-v+S,i-v+S);e.fillStyle="white",e.fillText(f,a+u-v,i-v)}u+=T-.5}}function orderTwoPos(e,t){return[[Math.min(e[0],t[0]),Math.min(e[1],t[1])],[Math.max(e[0],t[0]),Math.max(e[1],t[1])]]}function fillArea(e,t,n,a,i,o,s){var r=void 0===s;r&&(s=blocks),void 0===o&&(o=0);var l=e+n,c=t+a;null!==myPos&&r&&(e=Math.max(e,Math.round(myPos[0])-VIEWPORT_RADIUS),t=Math.max(t,Math.round(myPos[1])-VIEWPORT_RADIUS),l=Math.min(l,Math.round(myPos[0])+VIEWPORT_RADIUS),c=Math.min(c,Math.round(myPos[1])+VIEWPORT_RADIUS));for(var d=e;d<l;d++)for(var m=t;m<c;m++){var u=getBlock(d,m,s),p=applyPattern(i,o,d,m);u.setBlockId(p,400*Math.random())}}function applyPattern(e,t,n,a){var i,o;if(e<2)return e;var s=!1;switch(t){case 1:s=n%2==0&&a%2==0;break;case 2:s=n%2==(a%2==0?0:1);break;case 3:s=a%3<1?0<n%3:n%3<1;break;case 4:s=n%5==0||a%5==0;break;case 5:s=(n-a)%5==0;break;case 6:s=.5<Math.random();break;case 7:i=(n+7)%100,s=(o=(a+7)%100)<2&&(i<2||3<i&&i<6)||2==o&&1<i&&i<4||2<o&&o<5&&0<i&&i<5||5==o&&(1==i||4==i);break;case 8:s=n%2==(a%2==0?0:1)&&n%4!=0&&a%4!=1;break;case 9:s=mod(n%8<4?n+a:n-a-4,8)<3;break;case 10:s=n%2==(a%2==0?0:1)&&mod(n%8<4?n+a:n-a-4,8)<3;break;case 11:o=a%10,s=(0===(i=n%10)||6==i)&&o<7||(2==i||4==i)&&1<o&&o<5||(7==i||9==i)&&6<o||(0===o||6==o)&&i<7||(2==o||4==o)&&1<i&&i<5||(7==o||9==o)&&6<i;break;case 12:i=(a%12<6?n+5:n)%10,s=(o=a%6)<4&&0<i&&i<6&&3!=i||0<o&&o<3&&i<7||1<i&&i<5&&2<o&&o<5||3==i&&5==o;break;case 13:s=!(!((n+a)%10<1||mod(n-a,10)<1||(n+1)%10<3&&(a+1)%10<3||(n+6)%10<3&&(a+6)%10<3)||n%10==0&&a%10==0||n%10==5&&a%10==5);break;case 14:o=a%5,s=(1==(i=(a%10<5?n+5:n)%10)||4==i)&&1<o&&o<4||(1==o||4==o)&&1<i&&i<4;break;case 15:s=(n+a)%6<1||mod(n-a,6)<1&&n%6<3;break;case 16:o=a%6,s=1==(i=n%6)&&2<o&&o<5||4==i&&0<o&&o<3||4==o&&2<i&&i<5||1==o&&0<i&&i<3;break;case 17:s=.99<Math.random();break;case 18:case 19:case 20:case 21:case 22:case 23:case 24:case 25:case 26:case 27:var r,l,c,d=0,m=0;switch(t){case 18:c=l=18,m=6,r=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0],[0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,1,0,0],[0,0,0,0,0,1,1,1,1,0,0,1,0,0,0,1,0,0],[0,0,0,0,1,0,0,0,1,0,1,0,0,0,0,1,0,0],[1,1,1,1,1,1,1,0,0,1,0,0,0,0,0,1,0,0],[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0],[1,0,1,0,1,0,1,1,1,1,1,1,1,0,1,0,1,0],[1,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0],[1,0,1,0,1,0,1,1,0,0,1,0,0,0,0,0,1,0],[1,0,1,0,1,1,1,0,0,1,0,0,0,0,1,1,0,0],[1,0,1,0,1,1,0,0,1,0,0,0,0,1,0,1,0,0],[1,0,1,0,1,1,1,0,0,1,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,0,0,1,0,0,1,0,1,0,0,0],[1,0,1,1,1,1,0,1,0,0,1,0,0,1,0,0,0,0],[1,0,1,1,1,0,1,0,1,0,1,0,1,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0]];break;case 19:l=14,c=10,d=7,r=[[m=0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,1,0,0,0,0,1,1,0,0],[0,1,0,0,1,0,0,1,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,0,0,0,0,0,0,1,0,0],[0,0,0,1,0,0,0,0,1,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]];break;case 20:l=12,c=7,d=6,r=[[m=0,0,0,0,0,0,0,0,0,0,0,0],[0,1,0,0,0,1,0,0,1,1,1,0],[0,1,1,0,1,1,0,1,0,0,0,1],[0,1,0,1,0,1,0,1,0,0,0,0],[0,1,0,0,0,1,0,1,0,1,1,1],[0,1,0,0,0,1,0,1,0,0,0,1],[0,1,0,0,0,1,0,0,1,1,1,0]];break;case 21:l=17,c=15,m=5,r=[[1,1,1,1,1,d=0,0,1,1,0,0,1,1,1,1,1,1],[1,1,1,1,0,0,0,1,1,0,0,0,1,1,1,1,1],[0,1,1,1,0,0,0,1,1,0,0,0,1,1,1,0,1],[0,0,1,0,0,0,0,1,1,0,0,0,0,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,1,1,1,1,1,1,1,1,1,1,0,0,1,1],[1,1,0,1,1,1,1,0,0,1,1,1,1,0,1,1,1],[1,1,1,0,1,1,1,0,0,1,1,1,0,1,1,1,1],[1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1],[1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1],[1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1],[1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1],[1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]];break;case 22:c=l=10,r=[[1,m=d=0,0,0,0,0,0,0,0,0],[1,0,1,1,1,1,1,1,1,0],[1,0,0,1,0,1,0,1,0,0],[1,0,1,0,0,1,0,0,1,0],[1,1,1,1,0,1,0,1,1,1],[0,0,0,0,0,1,0,0,0,0],[1,1,1,1,0,1,0,1,1,1],[1,0,1,0,0,1,0,0,1,0],[1,0,0,1,0,1,0,1,0,0],[1,0,1,1,1,1,1,1,1,0]];break;case 23:l=12,c=7,d=6,r=[[m=0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,1,0,0,0,1],[0,0,1,0,1,0,0,1,1,0,1,1],[0,0,1,0,1,0,0,1,0,1,0,1],[0,1,1,1,1,1,0,1,0,0,0,1],[0,1,0,0,0,1,0,1,0,0,0,1],[0,1,0,0,0,1,0,1,0,0,0,1]];break;case 24:l=14,c=13,d=7,r=[[1,1,1,1,m=0,1,0,0,0,1,0,1,1,1],[1,1,1,0,0,1,0,0,0,1,0,0,1,1],[1,1,0,0,0,1,0,0,0,1,0,0,0,1],[1,1,0,0,0,1,1,1,1,1,0,0,0,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,0],[1,0,0,0,0,1,0,0,0,1,0,0,0,0],[1,0,0,0,1,1,1,0,0,1,1,1,0,0],[1,0,0,1,0,0,0,0,1,0,0,0,0,0],[1,0,0,1,0,1,1,0,0,1,1,0,0,0],[1,1,0,1,0,0,1,0,0,0,0,1,0,1],[1,1,0,0,1,1,0,0,1,1,1,0,0,1],[1,1,1,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,0,0,0,0,0,1,1,1,1]];break;case 25:l=22,c=7,d=11,r=[[m=0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,1,1,0,0,1,0,0,0,1,0,1,0,0,0,1,0,0,0,0],[0,1,0,0,0,1,0,0,1,0,1,0,0,1,1,0,1,1,0,0,0,0],[0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,1,0,1,0,0,0,0],[0,1,0,1,1,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0],[0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0],[0,0,1,1,1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]];break;case 26:l=15,c=19,m=6,r=[[d=0,0,0,1,1,0,0,0,0,1,1,0,0,0,0],[0,0,0,1,1,0,0,0,0,1,1,0,0,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],[0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],[0,0,0,1,1,0,0,0,0,1,1,0,0,0,0],[0,0,0,1,1,0,0,0,0,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];break;case 27:c=l=10,m=5,r=[[d=0,1,1,1,1,1,0,0,0,0],[1,1,0,0,0,1,1,0,0,0],[1,0,1,1,1,0,1,1,0,0],[1,0,1,1,1,1,0,1,0,0],[1,0,1,1,1,1,0,1,0,0],[1,0,1,1,1,0,1,1,0,0],[1,0,1,0,0,1,1,0,0,0],[1,0,1,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]]}i=(n+(d*=Math.floor(a/c)))%l,s=1==r[o=(a+(m*=Math.floor(n/l)))%c][i]}return s&&(e+=SKIN_BLOCK_COUNT),e}var currentTopNotifications=[];function doTopNotification(e){var t={text:e,elem:null,initiate:function(){var e=document.createElement("div");(this.elem=e).innerHTML=this.text,e.className="topNotification greenBox",e.style.visibility="hidden",document.getElementById("topNotifications").appendChild(e);var t=getColorForBlockSkinId(myColorId);colorBox(e,t.brighter,t.darker)},animationTimer:0,animationDirection:1,update:function(e){this.animationTimer+=.001*e*this.animationDirection;var t=lerp(-this.elem.offsetHeight-10,10,ease.out(clamp01(this.animationTimer)));this.elem.style.top=t+"px",this.elem.style.visibility=null,-1==this.animationDirection&&this.animationTimer<0&&this.destroy()},animateOut:function(){this.animationDirection=-1,1<this.animationTimer&&(this.animationTimer=1)},destroy:function(){this.elem.parentElement.removeChild(this.elem);for(var e=currentTopNotifications.length-1;0<=e;e--){currentTopNotifications[e]==this&&currentTopNotifications.splice(e,1)}}};return t.initiate(),currentTopNotifications.push(t),t}function bindSwipeEvents(){touchControlsElem.addEventListener("touchstart",onTouchStart),touchControlsElem.addEventListener("touchmove",onTouchMove),touchControlsElem.addEventListener("touchend",onTouchEnd),touchControlsElem.addEventListener("touchcancel",onTouchEnd)}function onTouchStart(e){var t=e.touches[e.touches.length-1];currentTouches.push({prevPos:[t.pageX,t.pageY],prevTime:Date.now(),id:t.identifier})}function onTouchMove(e){for(var t=e.touches,n=0;n<t.length;n++){for(var a=t[n],i=null,o=0;o<currentTouches.length;o++)if(currentTouches[o].id==a.identifier){i=currentTouches[o];break}i&&calcTouch(i,a)}e.preventDefault()}function calcTouch(e,t){var n=Date.now(),a=n-e.prevTime,i=[t.pageX,t.pageY],o=e.prevPos,s=o[0]-i[0],r=o[1]-i[1],l=Math.sqrt(Math.pow(s,2)+Math.pow(r,2))/a;l*=MAX_PIXEL_RATIO*canvasQuality,e.prevTime=n,e.prevPos=i,0<a&&2<l&&(Math.abs(s)>Math.abs(r)?sendDir(0<s?2:0):sendDir(0<r?3:1))}function onTouchEnd(e){for(var t=currentTouches.length-1;0<=t;t--)for(var n=0;n<e.touches.length;n++)currentTouches[t].id==e.touches[n].identifier&&(calcTouch(currentTouches[t],e.touches[n]),currentTouches.splice(t,1))}function doTransition(e,t,n,a,i){isTransitioning&&!i||(transitionText=e,isTransitioning=!0,transitionDirection=1,transitionTimer=transitionPrevTimer=0,transitionCanvas.style.display=null,void 0===t&&(t=!1),transitionReverseOnHalf=t,transitionCallback1=n,transitionCallback2=a)}function doSkipDeathTransition(){allowSkipDeathTransition&&(null!==deathTransitionTimeout&&(window.clearTimeout(deathTransitionTimeout),deathTransitionTimeout=null,onClose(),doTransition("",!1,function(){window.setTimeout(afterDeath,700),resetAll()})),skipDeathTransition=!0)}function rndSeed(e){var t=1e4*Math.sin(e);return t-Math.floor(t)}var ease={in:function(e){return e*e*e*e},out:function(e){return 1-Math.pow(1-e,4)},inout:function(e){return e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2}};function drawTitle(e,t,n,a,i){e.strokeStyle=n?colors.red.patternEdge:colors.red.brighter,e.lineWidth=16,e.lineJoin="round",e.lineCap="round",i?(e.shadowBlur=40*MAX_PIXEL_RATIO,e.shadowColor="rgba(0,0,0,0.4)",e.shadowOffsetX=e.shadowOffsetY=10*MAX_PIXEL_RATIO):e.shadowColor="rgba(0,0,0,0)";for(var o=titleTimer,s=0;s<titleLines.length;s++){var r=titleLines[s],l=clamp01(o*r.speed-r.offset),c=clamp01(o);c*=5,void 0!==a&&(c=Math.min(c,a)),e.beginPath();for(var d=0;d<r.line.length;d++){var m,u,p,h,g,f,T,y,v,S,C,P=r.line[d],x=clamp01(l*(r.line.length-1)-d+1);0<x&&(1==x?0===d&&2==P.length?e.moveTo(P[0]-c,P[1]-c):2==P.length?e.lineTo(P[0]-c,P[1]-c):6==P.length&&e.bezierCurveTo(P[0]-c,P[1]-c,P[2]-c,P[3]-c,P[4]-c,P[5]-c):(u=[(m=r.line[d-1])[m.length-2],m[m.length-1]],2==P.length?e.lineTo(lerp(u[0],P[0],x)-c,lerp(u[1],P[1],x)-c):6==P.length&&(p=[P[0],P[1]],h=[P[2],P[3]],g=[P[4],P[5]],f=lerpA(u,p,x),T=lerpA(p,h,x),y=lerpA(h,g,x),v=lerpA(f,T,x),S=lerpA(T,y,x),C=lerpA(v,S,x),e.bezierCurveTo(f[0]-c,f[1]-c,v[0]-c,v[1]-c,C[0]-c,C[1]-c))))}e.stroke()}}function drawBlocks(e,t,n){for(var a,i=0;i<t.length;i++){var o,s,r,l,c,d,m=t[i];n&&(m.x<camPos[0]-VIEWPORT_RADIUS||m.x>camPos[0]+VIEWPORT_RADIUS||m.y<camPos[1]-VIEWPORT_RADIUS||m.y>camPos[1]+VIEWPORT_RADIUS)||(0<m.animDelay?m.animDelay-=deltaTime:m.animProgress+=deltaTime*m.animDirection*.003,1<m.animProgress&&(m.animDirection=0,m.animProgress=1),m.animProgress<0?(m.currentBlock=m.nextBlock,m.animDirection=1,m.animProgress=0):(o=m.animProgress,0===m.currentBlock&&(e.fillStyle=colors.red.boundsDark,e.fillRect(10*m.x,10*m.y,10,10),uglyMode||(linesCtx.fillStyle=colors.grey.diagonalLines,linesCtx.fillRect(10*m.x,10*m.y,10,10))),1==m.currentBlock&&(.8<o&&!uglyMode&&(e.fillStyle=colors.grey.darker,e.fillRect(10*m.x+2,10*m.y+2,7,7)),e.fillStyle=colors.grey.brighter,1==o||uglyMode?e.fillRect(10*m.x+1,10*m.y+1,7,7):o<.4?(a=2.5*o,e.beginPath(),e.moveTo(10*m.x+2,10*m.y+lerp(9,2,a)),e.lineTo(10*m.x+2,10*m.y+9),e.lineTo(10*m.x+lerp(2,9,a),10*m.y+9),e.fill()):o<.8?(a=2.5*o-1,e.beginPath(),e.moveTo(10*m.x+2,10*m.y+2),e.lineTo(10*m.x+2,10*m.y+9),e.lineTo(10*m.x+9,10*m.y+9),e.lineTo(10*m.x+9,10*m.y+lerp(9,2,a)),e.lineTo(10*m.x+lerp(2,9,a),10*m.y+2),e.fill()):(a=5*o-4,e.fillRect(10*m.x+lerp(2,1,a),10*m.y+lerp(2,1,a),7,7))),2<=m.currentBlock&&(r=getColorForBlockSkinId(s=(m.currentBlock-2)%SKIN_BLOCK_COUNT),c=(l=m.currentBlock>SKIN_BLOCK_COUNT+1)?r.pattern:r.brighter,d=l?r.patternEdge:r.darker,.8<o&&!uglyMode&&(e.fillStyle=d,e.fillRect(10*m.x+1,10*m.y+1,9,9)),e.fillStyle=c,1==o||uglyMode?(e.fillRect(10*m.x,10*m.y,9,9),12!=s||uglyMode||(e.fillStyle=colors.gold.bevelBright,e.fillRect(10*m.x+3,10*m.y+.1,6,.1))):o<.4?(a=2.5*o,e.beginPath(),e.moveTo(10*m.x+1,10*m.y+lerp(10,1,a)),e.lineTo(10*m.x+1,10*m.y+10),e.lineTo(10*m.x+lerp(1,10,a),10*m.y+10),e.fill()):o<.8?(a=2.5*o-1,e.beginPath(),e.moveTo(10*m.x+1,10*m.y+1),e.lineTo(10*m.x+1,10*m.y+10),e.lineTo(10*m.x+10,10*m.y+10),e.lineTo(10*m.x+10,10*m.y+lerp(10,1,a)),e.lineTo(10*m.x+lerp(1,10,a),10*m.y+1),e.fill()):(a=5*o-4,e.fillRect(10*m.x+lerp(1,0,a),10*m.y+lerp(1,0,a),9,9)))))}}function drawPlayer(e,t,n){if(t.hasReceivedPosition){var a=getColorForBlockSkinId(t.skinBlock);if(0<t.trails.length)for(var i=t.trails.length-1;0<=i;i--){var o,s,r=t.trails[i],l=i==t.trails.length-1;l&&!t.isDead||(uglyMode?r.vanishTimer=10:(o=t.isDead&&l?.006:.02,r.vanishTimer+=deltaTime*o),!l&&10<r.vanishTimer&&t.trails.splice(i,1)),0<r.trail.length&&(s=l?t.drawPos:null,0<r.vanishTimer&&!uglyMode?(ctxApplyCamTransform(tempCtx,!0),drawTrailOnCtx([{ctx:tempCtx,color:a.darker,offset:5},{ctx:tempCtx,color:a.brighter,offset:4}],r.trail,s),tempCtx.globalCompositeOperation="destination-out",drawDiagonalLines(tempCtx,"white",r.vanishTimer,10,.003*n),e.restore(),tempCtx.restore(),linesCtx.restore(),e.drawImage(tempCanvas,0,0),tempCtx.fillStyle=colors.grey.diagonalLines,tempCtx.globalCompositeOperation="source-in",tempCtx.fillRect(0,0,tempCanvas.width,tempCanvas.height),linesCtx.drawImage(tempCanvas,0,0),ctxApplyCamTransform(e),ctxApplyCamTransform(linesCtx)):r.vanishTimer<10&&drawTrailOnCtx(uglyMode?[{ctx:e,color:a.darker,offset:5},{ctx:e,color:a.brighter,offset:4}]:[{ctx:e,color:a.darker,offset:5},{ctx:e,color:a.brighter,offset:4},{ctx:linesCtx,color:colors.grey.diagonalLines,offset:4}],r.trail,s))}var c,d,m,u,p,h,g=[10*t.drawPos[0]+4.5,10*t.drawPos[1]+4.5],f=e.createRadialGradient(g[0]-3,g[1]-3,0,g[0],g[1],6);if(f.addColorStop(0,a.slightlyBrighter),f.addColorStop(1,a.brighter),linesCtx.fillStyle="white",t.isDead){t.isDeadTimer+=.003*deltaTime,e.fillStyle=f;for(var T=0;T<t.deadAnimParts.length-1;T++){var y=t.deadAnimParts[T],v=t.deadAnimParts[T+1],S=lerp(y,v,.5),C=t.dir*Math.PI/2-Math.PI,P=Math.min(Math.abs(C-S),Math.abs(C-2*Math.PI-S),Math.abs(C+2*Math.PI-S)),x=t.deadAnimPartsRandDist[T],E=(1-Math.pow(2,-2*t.isDeadTimer))*P*5*(x+1),A=[Math.cos(S)*E,Math.sin(S)*E];e.globalAlpha=linesCtx.globalAlpha=Math.max(0,1-.2*t.isDeadTimer),e.beginPath(),e.arc(g[0]-.3+A[0],g[1]-.3+A[1],6,y,v,!1),e.lineTo(g[0]-.3+A[0],g[1]-.3+A[1]),e.fill(),uglyMode||(linesCtx.beginPath(),linesCtx.arc(g[0]-.3+A[0],g[1]-.3+A[1],6,y,v,!1),linesCtx.lineTo(g[0]-.3+A[0],g[1]-.3+A[1]),linesCtx.fill())}e.globalAlpha=linesCtx.globalAlpha=1}else e.fillStyle=a.darker,e.beginPath(),e.arc(g[0]+.3,g[1]+.3,6,0,2*Math.PI,!1),e.fill(),e.fillStyle=f,e.beginPath(),e.arc(g[0]-.3,g[1]-.3,6,0,2*Math.PI,!1),e.fill(),t.isMyPlayer&&"true"==localStorage.drawWhiteDot&&(e.fillStyle="white",e.beginPath(),e.arc(g[0]-.3,g[1]-.3,1,0,2*Math.PI,!1),e.fill()),uglyMode||(linesCtx.beginPath(),linesCtx.arc(g[0]+.3,g[1]+.3,6,0,2*Math.PI,!1),linesCtx.fill(),linesCtx.beginPath(),linesCtx.arc(g[0]-.3,g[1]-.3,6,0,2*Math.PI,!1),linesCtx.fill());if(t.isMyPlayer&&"true"==localStorage.drawActualPlayerPos&&(e.fillStyle="#FF0000",e.beginPath(),e.arc(10*t.serverPos[0]+5,10*t.serverPos[1]+5,6,0,2*Math.PI,!1),e.fill()),0<t.hitLines.length)for(var I=t.hitLines.length-1;0<=I;I--){var b=t.hitLines[I];b.vanishTimer+=.004*deltaTime;var k,D,M,B,R=b.vanishTimer;4<R&&t.hitLines.splice(I,1),p=10*b.pos[0]+5,h=10*b.pos[1]+5,R<2&&(k=Math.max(0,18*ease.out(iLerp(0,2,R))),D=Math.max(0,18*ease.out(iLerp(.5,2,R))),e.fillStyle=a.brighter,e.beginPath(),e.arc(p,h,k,0,2*Math.PI,!1),e.arc(p,h,D,0,2*Math.PI,!1),e.fill("evenodd"),uglyMode||(linesCtx.beginPath(),linesCtx.arc(p,h,k,0,2*Math.PI,!1),linesCtx.arc(p,h,D,0,2*Math.PI,!1),linesCtx.fill("evenodd"))),void 0!==b.color&&t.isMyPlayer&&(e.save(),e.font=linesCtx.font="6px Arial, Helvetica, sans-serif",e.fillStyle=b.color.brighter,e.shadowColor=b.color.darker,e.shadowOffsetX=e.shadowOffsetY=.4*MAX_PIXEL_RATIO*zoom*canvasQuality,w=e.measureText("+500").width,B=clamp01(B=R<.5?iLerp(0,.5,R):R<3.5?1:iLerp(4,3.5,R)),M=R<2?20*ease.out(R/2):20,e.globalAlpha=B,e.fillText("+500",p-w/2,h-M),e.restore())}t.honkTimer<t.honkMaxTime&&(t.honkTimer+=.255*deltaTime,e.fillStyle=a.brighter,e.globalAlpha=clamp01(iLerp(t.honkMaxTime,0,t.honkTimer)),e.beginPath(),e.arc(10*t.drawPos[0]+4.5+.3,10*t.drawPos[1]+4.5+.3,6+.1*t.honkTimer,0,2*Math.PI,!1),e.fill(),e.globalAlpha=1,uglyMode||(linesCtx.globalAlpha=clamp01(iLerp(t.honkMaxTime,0,t.honkTimer)),linesCtx.beginPath(),linesCtx.arc(10*t.drawPos[0]+4.5+.3,10*t.drawPos[1]+4.5+.3,6+.1*t.honkTimer,0,2*Math.PI,!1),linesCtx.fill(),linesCtx.globalAlpha=1)),"true"!=localStorage.hidePlayerNames&&(myNameAlphaTimer+=.001*deltaTime,e.font=linesCtx.font=USERNAME_SIZE+"px Arial, Helvetica, sans-serif",t.name&&(d=c=1,t.isMyPlayer&&(d=9-myNameAlphaTimer),t.isDead&&(c=1-t.isDeadTimer),0<(m=Math.min(c,d))&&(e.save(),uglyMode||linesCtx.save(),e.globalAlpha=clamp01(m),u=e.measureText(t.name).width,u=Math.min(100,u),p=10*t.drawPos[0]+5-u/2,h=10*t.drawPos[1]-5,e.rect(p-4,h-1.2*USERNAME_SIZE,u+8,2*USERNAME_SIZE),e.clip(),uglyMode||(linesCtx.rect(p-4,h-1.2*USERNAME_SIZE,u+8,2*USERNAME_SIZE),linesCtx.clip(),linesCtx.fillText(t.name,p,h)),e.shadowColor="rgba(0,0,0,0.9)",e.shadowBlur=10,e.shadowOffsetX=e.shadowOffsetY=2,e.fillStyle=a.brighter,e.fillText(t.name,p,h),e.shadowColor=a.darker,e.shadowBlur=0,e.shadowOffsetX=e.shadowOffsetY=.8,e.fillText(t.name,p,h),e.restore(),uglyMode||linesCtx.restore()))),"Jesper"!=t.name||t.isDead||(e.fillStyle="black",e.fillRect(g[0]-6.5,g[1]-2,13,1),e.fillRect(g[0]-1,g[1]-2,2,2),e.fillRect(g[0]-5.5,g[1]-2,5,3),e.fillRect(g[0]+.5,g[1]-2,5,3))}}function moveDrawPosToPos(e){var t=null,t=e.isDead&&!e.deathWasCertain?e.uncertainDeathPosition:e.pos;e.drawPos[0]=lerpt(e.drawPos[0],t[0],.23),e.drawPos[1]=lerpt(e.drawPos[1],t[1],.23)}function movePos(e,t,n){switch(t){case 0:e[0]+=n;break;case 1:e[1]+=n;break;case 2:e[0]-=n;break;case 3:e[1]-=n}}var qualityText,uglyText,dtCaps=[0,6.5,16,33,49,99];function getDtCap(e){return dtCaps[clamp(e,0,dtCaps.length-1)]}function toggleQuality(){switch(localStorage.quality){case"auto":lsSet("quality","0.4");break;case"0.4":lsSet("quality","0.7");break;case"0.7":lsSet("quality","1");break;case"1":lsSet("quality","auto")}setQuality()}function setQuality(){null===localStorage.getItem("quality")&&lsSet("quality","1"),"auto"!=localStorage.quality?(canvasQuality=parseFloat(localStorage.quality),qualityText.innerHTML="Quality: "+{.4:"low",.7:"medium",1:"high"}[localStorage.quality]):qualityText.innerHTML="Quality: auto"}function setUglyText(){updateUglyMode();var e=uglyMode?"on":"off";uglyText.innerHTML="Ugly mode: "+e}function toggleUglyMode(){switch(localStorage.uglyMode){case"true":lsSet("uglyMode","false");break;case"false":default:lsSet("uglyMode","true")}setUglyText()}function updateUglyMode(){uglyMode="true"==localStorage.uglyMode}function setLeaderboardVisibility(){leaderboardDivElem.style.display=leaderboardHidden?"none":null}function loop(e){var t,n=e-prevTimeStamp;if(lerpedDeltaTime=lerpedDeltaTime<n?n:lerpt(lerpedDeltaTime,n,.05),"auto"!=localStorage.quality&&null!==localStorage.getItem("quality")||(33<lerpedDeltaTime?canvasQuality-=.01:lerpedDeltaTime<28&&(canvasQuality+=.01),canvasQuality=Math.min(1,Math.max(.4,canvasQuality))),n<lerp(getDtCap(currentDtCap),getDtCap(currentDtCap-1),.9))for(gainedFrames.push(Date.now());190<gainedFrames.length;){if(!(1e4<Date.now()-gainedFrames[0])){gainedFrames=[],currentDtCap=clamp(--currentDtCap,0,dtCaps.length-1);break}gainedFrames.splice(0,1)}if(n>lerp(getDtCap(currentDtCap),getDtCap(currentDtCap+1),.05))for(missedFrames.push(Date.now()),gainedFrames=[];5<missedFrames.length;){if(!(5e3<Date.now()-missedFrames[0])){missedFrames=[],currentDtCap=clamp(++currentDtCap,0,dtCaps.length-1);break}missedFrames.splice(0,1)}if(prevTimeStamp=e,(deltaTime=n+totalDeltaTimeFromCap)<getDtCap(currentDtCap)&&"true"!=localStorage.dontCapFps)totalDeltaTimeFromCap+=n;else{totalDeltaTimeFromCap=0,canvasTransformType=canvasTransformTypes.MAIN,ctxCanvasSize(ctx),uglyMode||ctxCanvasSize(linesCtx),ctx.fillStyle=colors.grey.BG,ctx.fillRect(0,0,mainCanvas.width,mainCanvas.height),uglyMode||(linesCtx.fillStyle="white",linesCtx.fillRect(0,0,linesCanvas.width,linesCanvas.height)),camPosPrevFrame=[camPos[0],camPos[1]],calcCamOffset(),ctxApplyCamTransform(ctx),uglyMode||ctxApplyCamTransform(linesCtx),drawBlocks(ctx,blocks,!0);for(var a,i,o,s,r,l,c,d,m,u,p=deltaTime*GLOBAL_SPEED,h=0;h<players.length;h++){var g,f=players[h];f.isDead&&f.deathWasCertain||(f.moveRelativeToServerPosNextFrame&&(p=(Date.now()-f.lastServerPosSentTime)*GLOBAL_SPEED),f.isMyPlayer&&(movePos(f.serverPos,f.serverDir,p),f.serverDir==f.dir&&(g=0,"true"!=localStorage.dontSlowPlayersDown&&(0===f.dir||2==f.dir?f.pos.y==f.serverPos.y&&(g=0===f.dir?f.pos[0]-f.serverPos[0]:f.serverPos[0]-f.pos[0]):f.pos.x==f.serverPos.x&&(g=1==f.dir?f.pos[1]-f.serverPos[1]:f.serverPos[1]-f.pos[1])),p*=lerp(.5,1,iLerp(5,0,g=Math.max(0,g))))),movePos(f.pos,f.dir,p)),f.moveRelativeToServerPosNextFrame=!1,moveDrawPosToPos(f);var T,y,v,S,C,P=!1;if(f.drawPos[0]<=0||f.drawPos[1]<=0||f.drawPos[0]>=mapSize-1||f.drawPos[1]>=mapSize-1)P=!0;else if(0<f.trails.length){t=f.trails[f.trails.length-1].trail;var x=[Math.round(f.drawPos[0]),Math.round(f.drawPos[1])];if(Math.abs(x[0]-f.drawPos[0])<.2&&Math.abs(x[1]-f.drawPos[1])<.2)for(var E=!0,A=t.length-3;0<=A;A--)var I=orderTwoPos([Math.round(t[A][0]),Math.round(t[A][1])],[Math.round(t[A+1][0]),Math.round(t[A+1][1])]),E=x[0]>=I[0][0]&&x[0]<=I[1][0]&&x[1]>=I[0][1]&&x[1]<=I[1][1]&&(E||(P=!0),!0)}P?f.isDead||f.die():f.didUncertainDeathLastTick=!1,f.isDead&&!f.deathWasCertain&&1.5<f.isDeadTimer&&(f.isDead=!1,0<f.trails.length&&((t=f.trails[f.trails.length-1]).vanishTimer=0)),f.isMyPlayer&&(myPos=[f.pos[0],f.pos[1]],miniMapPlayer.style.left=myPos[0]/mapSize*160+1.5+"px",miniMapPlayer.style.top=myPos[1]/mapSize*160+1.5+"px",camPosSet?(camPos[0]=lerpt(camPos[0],f.pos[0],.03),camPos[1]=lerpt(camPos[1],f.pos[1],.03)):(camPos=[f.pos[0],f.pos[1]],camPosSet=!0),myNextDir!=f.dir&&(T=0===f.dir||2==f.dir,changeDirAtIsHorizontal!=T&&(y=!1,v=f.pos[T?0:1],0===f.dir||1==f.dir?changeDirAt<v&&(y=!0):v<changeDirAt&&(y=!0),y&&(S=[f.pos[0],f.pos[1]],C=Math.abs(changeDirAt-v),S[T?0:1]=changeDirAt,changeMyDir(myNextDir,S),movePos(f.pos,f.dir,C))))),drawPlayer(ctx,f,e)}0<sendDirQueue.length&&(a=sendDirQueue[0],(Date.now()-a.addTime>1.2/GLOBAL_SPEED||sendDir(a.dir,!0))&&sendDirQueue.shift()),uglyMode||drawDiagonalLines(linesCtx,"white",5,10,.008*e),ctx.restore(),uglyMode||(linesCtx.restore(),ctx.globalCompositeOperation="multiply",ctx.drawImage(linesCanvas,0,0),ctx.globalCompositeOperation="source-over"),scoreStat=lerpt(scoreStat,scoreStatTarget,.1),myScoreElem.innerHTML=Math.round(scoreStat),realScoreStat=lerpt(realScoreStat,realScoreStatTarget,.1),myRealScoreElem.innerHTML=Math.round(realScoreStat),isTransitioning&&(i=60,0,o=5,i*=MAX_PIXEL_RATIO,o*=MAX_PIXEL_RATIO,transitionTimer+=deltaTime*transitionDirection*.001,1==transitionDirection&&null!==transitionCallback1&&.5<=transitionTimer&&transitionPrevTimer<.5&&(transitionTimer=.5,transitionCallback1()),-1==transitionDirection&&null!==transitionCallback2&&transitionTimer<=.5&&.5<transitionPrevTimer&&(transitionTimer=.5,transitionCallback2()),transitionReverseOnHalf&&1==transitionDirection&&3<=transitionTimer&&transitionPrevTimer<3&&(transitionDirection=-1,transitionTimer=1),(transitionPrevTimer=transitionTimer)<=0&&transitionReverseOnHalf||3.5<=transitionTimer&&!transitionReverseOnHalf?(transitionDirection=0,isTransitioning=!1,transitionCanvas.style.display="none"):(ctxCanvasSize(tCtx,!0),s=transitionCanvas.width,r=transitionCanvas.height,(u=transitionTimer)<.5?(m=2*u,m=ease.in(m),tCtx.fillStyle=colors.green2.darker,tCtx.fillRect(0,lerp(-10,r/2,m),s,10),tCtx.fillStyle=colors.green2.brighter,tCtx.fillRect(0,-10,s,lerp(0,r/2+10,m)),tCtx.fillRect(0,lerp(r,r/2,m),s,r)):u<1?(m=2*u-1,m=ease.out(m),transitionText?(tCtx.fillStyle=colors.green2.darker,tCtx.fillRect(0,lerp(0,r/2-i/2,m),s,lerp(r,10+i,m)),tCtx.fillStyle=colors.green2.brighter,tCtx.fillRect(0,lerp(0,r/2-i/2,m),s,lerp(r,i,m))):(tCtx.fillStyle=colors.green2.darker,tCtx.fillRect(0,lerp(0,r/2,m),s,lerp(r,10,m)),tCtx.fillStyle=colors.green2.brighter,tCtx.fillRect(0,lerp(0,r/2,m),s,lerp(r,0,m)))):u<3?transitionText?(tCtx.fillStyle=colors.green2.darker,tCtx.fillRect(0,r/2,s,i/2+10),tCtx.fillStyle=colors.green2.brighter,tCtx.fillRect(0,r/2-i/2,s,i)):transitionTimer=3.5:u<3.5&&(m=2*(u-2-1),m=ease.in(m),tCtx.fillStyle=colors.green2.darker,tCtx.fillRect(0,r/2,s,lerp(i/2+10,10,m)),tCtx.fillStyle=colors.green2.brighter,tCtx.fillRect(0,lerp(r/2-i/2,r/2,m),s,lerp(i,0,m))),.5<u&&u<3.5&&(l=i-20,tCtx.font=l+"px Arial, Helvetica, sans-serif",c=s/2-tCtx.measureText(transitionText).width/2+o/2,d=r/2+.37*l+o/2,m=(m=u)<1.1?iLerp(.5,1.1,u):u<2.9?1:iLerp(3.5,2.9,u),drawAnimatedText(tCtx,transitionText,m,c,d,l,"white","Arial, Helvetica, sans-serif",o,3,16842438)),tCtx.restore()),skipDeathTransition&&"GAME OVER"==transitionText&&1<transitionTimer&&(transitionTimer=1.1,skipDeathTransition=allowSkipDeathTransition=!(transitionDirection=-1))),renderAllLives(deltaTime);for(var b,k,w,D,M,B,R,L,O,N=currentTopNotifications.length-1;0<=N;N--){currentTopNotifications[N].update(deltaTime)}engagementSetIsPlaying(playingAndReady&&Date.now()-lastSendDirTime<2e4),beginScreenVisible&&49<e-titleLastRender&&(resetTitleNextFrame&&(resetTitleNextFrame=!1,titleTimer=-1,titleLastRender=e),titleTimer+=.002*(e-titleLastRender),titleLastRender=e,canvasTransformType=canvasTransformTypes.TITLE,ctxCanvasSize(titCtx,!0),ctxApplyCamTransform(titCtx,!1,!0),drawTitle(titCtx,titleTimer,!0,0,!0),drawTitle(titCtx,titleTimer,!0,2.5),drawTitle(titCtx,titleTimer),titCtx.restore()),beginScreenVisible&&(tutorialTimer+=deltaTime*GLOBAL_SPEED*.7,canvasTransformType=canvasTransformTypes.TUTORIAL,ctxCanvasSize(tutCtx),uglyMode||ctxCanvasSize(linesCtx),tutCtx.fillStyle=colors.grey.BG,tutCtx.fillRect(0,0,tutorialCanvas.width,tutorialCanvas.height),uglyMode||(linesCtx.fillStyle="white",linesCtx.fillRect(0,0,linesCanvas.width,linesCanvas.height)),ctxApplyCamTransform(tutCtx),uglyMode||ctxApplyCamTransform(linesCtx),u=tutorialTimer,drawBlocks(tutCtx,tutorialBlocks),b=getPlayer(1,tutorialPlayers),k=getPlayer(2,tutorialPlayers),u<10?b.pos=[2,2]:u<15?b.pos=[u-8,2]:u<18?b.pos=[7,u-13]:u<23?b.pos=[25-u,5]:u<26?b.pos=[2,28-u]:u<30||(u<36?b.pos=[2,u-28]:u<39&&(b.pos=[u-34,8])),u<12||(u<15?b.trails=[{trail:[[4,2]],vanishTimer:0}]:u<18?b.trails=[{trail:[[4,2],[7,2]],vanishTimer:0}]:u<23?b.trails=[{trail:[[4,2],[7,2],[7,5]],vanishTimer:0}]:u<24&&(b.trails=[{trail:[[4,2],[7,2],[7,5],[2,5]],vanishTimer:0}])),24<u&&tutorialPrevTimer<24&&(b.trails=[{trail:[[4,2],[7,2],[7,5],[2,5],[2,4]],vanishTimer:0},{trail:[],vanishTimer:0}]),u<34||(u<36?b.trails=[{trail:[[2,6]],vanishTimer:0}]:u<39&&(b.trails=[{trail:[[2,6],[2,8]],vanishTimer:0}])),u<34||u<50&&(k.pos=[u-37,7],k.trails=[{trail:[[-2,7]],vanishTimer:0}]),25<u&&tutorialPrevTimer<25&&fillArea(2,2,6,4,10,0,tutorialBlocks),39<u&&tutorialPrevTimer<39&&(b.die(!0),fillArea(1,1,7,5,1,0,tutorialBlocks),k.addHitLine([2,7])),50<u&&(fillArea(1,1,3,3,10,tutorialTimer=tutorialPrevTimer=0,tutorialBlocks),b.isDeadTimer=0,b.isDead=!1,b.trails=[],b.pos=[100,100],k.trails=[{trail:[[-2,7],[12,7]],vanishTimer:0},{trail:[],vanishTimer:0}],k.pos=k.drawPos=[-2,7]),1<u&&tutorialPrevTimer<1&&(tutorialText.innerHTML="Close an area to fill it with your color."),30<u&&tutorialPrevTimer<30&&(tutorialText.innerHTML="Don't get hit by other players."),w=clamp01(5-Math.abs(.5*(u-20))),w+=clamp01(4-Math.abs(.5*(u-40))),tutorialText.style.opacity=clamp(w,0,.9),moveDrawPosToPos(b),moveDrawPosToPos(k),tutCtx.globalAlpha=Math.min(1,Math.max(0,.3*u-1)),drawPlayer(tutCtx,b,e),drawPlayer(tutCtx,k,e),tutCtx.globalAlpha=1,tutorialPrevTimer=u,uglyMode||drawDiagonalLines(linesCtx,"white",5,10,.008*e),tutCtx.restore(),uglyMode||(linesCtx.restore(),tutCtx.globalCompositeOperation="multiply",tutCtx.drawImage(linesCanvas,0,0),tutCtx.globalCompositeOperation="source-over")),beginScreenVisible&&(canvasTransformType=canvasTransformTypes.SKIN_BUTTON,ctxApplyCamTransform(skinButtonCtx,!0,!0),drawBlocks(skinButtonCtx,skinButtonBlocks),skinButtonCtx.restore()),skinScreenVisible&&(canvasTransformType=canvasTransformTypes.SKIN,ctxApplyCamTransform(skinCtx,!0),drawBlocks(skinCtx,skinScreenBlocks),skinCtx.restore()),beginScreenVisible&&(socialOpacity=lerpt(socialOpacity,socialOTarget,.1),socialElem.style.opacity=Math.min(1,socialOpacity),animateAppLinks&&(appLinksTimer+=.003*deltaTime,appLinksElem.style.opacity=Math.min(1,Math.max(0,appLinksTimer)),1<appLinksTimer&&(animateAppLinks=!1))),beginScreenVisible&&(1<(u=(lastStatTimer+=deltaTime)/2e3)&&(lastStatTimer=0,5<++lastStatCounter&&(lastStatCounter=0),0===lastStatCounter&&(lastStatNo1Time<=0&&bestStatNo1Time<=0?lastStatCounter++:(lastStatValueElem.innerHTML=parseTimeToString(lastStatNo1Time)+" on #1",bestStatValueElem.innerHTML=parseTimeToString(bestStatNo1Time)+" on #1")),1==lastStatCounter&&(""===lastStatKiller&&0<lastStatKiller.replace(/\s/g,"").length?lastStatCounter++:(lastStatValueElem.innerHTML="killed by "+filter(htmlEscape(lastStatKiller)),bestStatValueElem.innerHTML="")),2==lastStatCounter&&(lastStatKills<=0&&bestStatKills<=0?lastStatCounter++:(D=1==lastStatKills?"":"s",lastStatValueElem.innerHTML=lastStatKills+" player"+D+" killed",M=1==bestStatKills?"":"s",bestStatValueElem.innerHTML=bestStatKills+" player"+M+" killed")),3==lastStatCounter&&(lastStatValueElem.innerHTML=parseTimeToString(lastStatAlive)+" alive",bestStatValueElem.innerHTML=parseTimeToString(Math.max(lastStatAlive,localStorage.getItem("bestStatAlive")))+" alive"),4==lastStatCounter&&(lastStatBlocks<=0&&bestStatBlocks<=0?lastStatCounter++:(B=1==lastStatBlocks?"":"s",lastStatValueElem.innerHTML=lastStatBlocks+" block"+B+" captured",R=1==bestStatBlocks?"":"s",bestStatValueElem.innerHTML=bestStatBlocks+" block"+R+" captured")),5==lastStatCounter&&(lastStatLbRank<=0&&bestStatLbRank<=0?lastStatCounter=0:(lastStatValueElem.innerHTML=0==lastStatLbRank?"":"#"+lastStatLbRank+" highest rank",bestStatValueElem.innerHTML=0==bestStatLbRank?"":"#"+bestStatLbRank+" highest rank"))),lastStatValueElem.style.opacity=bestStatValueElem.style.opacity=5-Math.abs(5*(u-.5)*2)),beginScreenVisible&&1e3<Date.now()-lastNameChangeCheck&&(lastNameValue!=nameInput.value&&(nameInputOnChange(),lastNameValue=nameInput.value),lastTeamNameValue!=teamNameInput.value&&(teamNameInputOnChange(),lastTeamNameValue=teamNameInput.value),lastNameChangeCheck=Date.now()),"true"==localStorage.drawDebug&&(L="avg:"+Math.round(thisServerAvgPing)+" last:"+Math.round(thisServerLastPing)+" diff:"+Math.round(thisServerDiffPing),ctx.font="14px Arial, Helvetica, sans-serif",ctx.fillStyle=colors.red.brighter,O=ctx.measureText(L).width,ctx.fillText(L,ctx.canvas.width-O-10,ctx.canvas.height-10)),loopRetentionSamples(deltaTime),testAdBoxLoaded(),testAdBox2Loaded()}donePing||pingServers();var _=Date.now()-lastMyPosSetClientSideTime,U=Date.now()-lastMyPosSetValidClientSideTime,W=Date.now()-lastMyPosServerSideTime;WAIT_FOR_DISCONNECTED_MS<U&&WAIT_FOR_DISCONNECTED_MS<W-_&&!myPlayer.isDead?connectionLostNotification=connectionLostNotification||doTopNotification("It seems like you're disconnected. Please check your connection."):connectionLostNotification&&(connectionLostNotification.animateOut(),connectionLostNotification=null);var H=waitingForPing?1e4:5e3;null!==ws&&Date.now()-lastPingTime>H&&(lastPingTime=Date.now(),wsSendMsg(sendAction.PING)&&(waitingForPing=!0)),parseGamepads(),window.requestAnimationFrame(loop)}var currentGamepad,gamePadIsHonking=!1,customMappings=[{name:"Generic USB Joystick",buttonMap:{0:2,1:1,2:3,3:0,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:13,13:14,14:15,15:16},axesMap:{0:0,1:1,2:2,3:4}},{name:"Bluetooth Gamepad",buttonMap:{0:0,1:1,2:3,3:4,4:6,5:7,6:8,7:9,8:10,9:11,10:13,11:14,12:12,13:13,14:14,15:15},axesMap:{0:0,1:1,2:2,3:5}},{name:"USB DancePad",buttonMap:{0:6,1:7,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:0,13:1,14:2,15:3},axesMap:{0:0,1:1,2:2,3:4}}],currentMap={buttonMap:{0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,14:14,15:15},axesMap:{0:0,1:1,2:2,3:3}};function getButton(e){if(currentGamepad&&currentGamepad.buttons){var t=currentGamepad.buttons[currentMap.buttonMap[e]];if(t)return t.pressed}return!1}function getAxis(e){if(currentGamepad&&currentGamepad.axes){var t=currentGamepad.axes[currentMap.axesMap[e]];if(void 0!==t)return t}return 0}function parseGamepads(){if("getGamepads"in navigator){for(var e=navigator.getGamepads(),t=!1,n=0;n<e.length;n++)if(null!=(currentGamepad=e[n])){var a=!1;if("standard"==currentGamepad.mapping)currentMap={buttonMap:{0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,14:14,15:15},axesMap:{0:0,1:1,2:2,3:3}},a=!0;else for(var i=0;i<customMappings.length;i++)0<=currentGamepad.id.indexOf(customMappings[i].name)&&(a=!0,currentMap=customMappings[i]);a&&(getButton(12)&&sendDir(3),getButton(13)&&sendDir(1),getButton(14)&&sendDir(2),getButton(15)&&sendDir(0),getButton(0)&&(t=!0),getButton(1)&&doSkipDeathTransition(),getButton(9)&&sendDir(4),(getAxis(0)<-.9||getAxis(2)<-.9)&&sendDir(2),(.9<getAxis(0)||.9<getAxis(2))&&sendDir(0),(getAxis(1)<-.9||getAxis(3)<-.9)&&sendDir(3),(.9<getAxis(1)||.9<getAxis(3))&&sendDir(1))}t?beginScreenVisible?connectWithTransition():gamePadIsHonking||(gamePadIsHonking=!0,honkStart()):gamePadIsHonking&&(gamePadIsHonking=!1,honkEnd())}}function toUTF8Array(e){for(var t=[],n=0;n<e.length;n++){var a=e.charCodeAt(n);a<128?t.push(a):a<2048?t.push(192|a>>6,128|63&a):a<55296||57344<=a?t.push(224|a>>12,128|a>>6&63,128|63&a):(n++,a=65536+((1023&a)<<10|1023&e.charCodeAt(n)),t.push(240|a>>18,128|a>>12&63,128|a>>6&63,128|63&a))}return t}function htmlEscape(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}var swearArr=[];simpleRequest("swearList.txt",function(e){swearArr=e.split("\n").filter(function(e){return e})});var swearRepl="balaboo";function filter(e){for(var t=(e=e.replace(/[]/g,"")).split(" "),n=0;n<t.length;n++){for(var a=t[n],i=a.toUpperCase()==a,o=0;o<swearArr.length;o++){var s=swearArr[o];0<=a.toLowerCase().indexOf(s)&&(a=a.length<s.length+2?swearRepl:a.toLowerCase().replace(s,swearRepl))}i&&(a=a.toUpperCase()),t[n]=a}return t.join(" ")}function Utf8ArrayToStr(e){for(var t,n,a,i="",o=e.length,s=0;s<o;)switch((t=e[s++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:i+=String.fromCharCode(t);break;case 12:case 13:n=e[s++],i+=String.fromCharCode((31&t)<<6|63&n);break;case 14:n=e[s++],a=e[s++],i+=String.fromCharCode((15&t)<<12|(63&n)<<6|(63&a)<<0)}return i}function bytesToInt(){for(var e=0,t=0,n=arguments.length-1;0<=n;n--){e=(e|(255&arguments[n])<<t>>>0)>>>0;t+=8}return e}function intToBytes(e,t){for(var n=[],a=0;a<t;a++){var i=255&e;e=(e-(n[t-a-1]=i))/256}return n}function parseTimeToString(e){var t=Math.floor(e/3600),n=Math.floor((e-3600*t)/60);if(e=e-3600*t-60*n,t<=0){var a=1==e?"":"s";return n<=0?e+" second"+a:n+" minute"+(1==n?"":"s")+" and "+e+" second"+a}return t<10&&(t="0"+t),n<10&&(n="0"+n),e<10&&(e="0"+e),t+":"+n+":"+e}function parseQuery(e){var t=e.indexOf("?");if(t<0)return{};for(var n=e.substr(t+1).split("&"),a={},i=0;i<n.length;i++){var o=n[i].split("=");2==o.length&&(a[o[0]]=o[1])}return a}
